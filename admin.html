<!-- File: admin_app.html -->
<!-- Syntax & Logic Check: PASSED -->
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="robots" content="noindex,nofollow" />
    <title>ç®¡ç†è€…ã‚¢ãƒ—ãƒª | v8.3.0 STABLE</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f8fafc;
        color: #1e293b;
        overflow-x: hidden;
      }

      .sidebar {
        background: #0f172a;
        width: 320px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 50;
        height: 100dvh;
        position: fixed;
        left: -320px;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
      }

      .sidebar.open {
        left: 0;
      }

      .sidebar-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 45;
        display: none;
      }

      .sidebar.open + .sidebar-backdrop {
        display: block;
      }

      .main {
        margin-left: 0;
        padding: 2rem;
        min-height: 100dvh;
        width: 100%;
        transition: margin-left 0.3s;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
      }

      @media (min-width: 1024px) {
        .sidebar {
          left: 0;
          position: sticky;
          border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .mobile-header {
          display: none;
        }
      }

      @media (max-width: 1023px) {
        .main {
          padding: 1.5rem;
          padding-top: 5rem;
        }
      }

      .mobile-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 4rem;
        background: #0f172a;
        z-index: 40;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 1.5rem;
      }

      input[type="number"]::-webkit-outer-spin-button,
      input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none !important;
        margin: 0 !important;
      }

      input[type="number"] {
        -moz-appearance: textfield !important;
        appearance: none !important;
      }

      .input-ev {
        background: #f1f5f9;
        border: 2px solid transparent;
        font-weight: 900;
        border-radius: 1rem;
        padding: 0.8rem;
        width: 110px;
        text-align: center;
        color: #0076ff;
        outline: none;
        transition: all 0.2s;
      }

      .input-ev:focus {
        border-color: #0076ff;
        background: #ffffff;
      }

      .custom-scroll::-webkit-scrollbar {
        width: 4px;
      }

      .custom-scroll::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-fadeIn {
        animation: fadeIn 0.3s ease-out forwards;
      }

      /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æœ€é©åŒ–ã‚¯ãƒ©ã‚¹ */
      .scroll-container {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
      }
    </style>
  </head>

  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect } = React;
      const GAS_URL =
        "https://script.google.com/macros/s/AKfycbzPIDjd4AXjH5FLFltk_cwNJM7NMG5WLDsS4Q3LgCSkL_gXX7s0NA3jm7UckOGdzQeQlQ/exec";
      const APP_PASS = "nogawa";

      // åŒ—æ–—ã®æœŸå¾…å€¤ãƒ¬ãƒ³ã‚¸è¨ˆç®—ç”¨å…±é€šé–¢æ•°
      const matchEvInRange = (val, mData) => {
        if (mData === undefined || mData === null) return 0;
        const gKeys = Object.keys(mData)
          .map(Number)
          .filter((n) => !isNaN(n))
          .sort((a, b) => a - b);
        if (gKeys.length === 0) return 0;
        if (mData[val] !== undefined) return mData[val];
        if (val <= gKeys[0]) return mData[gKeys[0]];
        if (val >= gKeys[gKeys.length - 1])
          return mData[gKeys[gKeys.length - 1]];
        const lower = [...gKeys].reverse().find((k) => k <= val);
        const upper = gKeys.find((k) => k >= val);
        if (lower !== undefined && upper !== undefined) {
          const lowEv = mData[lower];
          const upEv = mData[upper];
          if (lower === upper) return lowEv;
          const ev = lowEv + ((upEv - lowEv) * (val - lower)) / (upper - lower);
          return Math.round(ev);
        }
        return 0;
      };

      function ArchiveLibrary({ archive, onClose }) {
        const [search, setSearch] = React.useState("");
        const [nameFilter, setNameFilter] = React.useState("");
        const [storeFilter, setStoreFilter] = React.useState("");

        const nameList = React.useMemo(() => {
          const names = new Set();
          const targetData = storeFilter
            ? (archive || []).filter((d) => d.store === storeFilter)
            : archive || [];
          targetData.forEach((item) => {
            if (item.name) names.add(item.name);
          });
          return Array.from(names).sort();
        }, [archive, storeFilter]);

        const storeList = React.useMemo(() => {
          const stores = new Set();
          const targetData = nameFilter
            ? (archive || []).filter((d) => d.name === nameFilter)
            : archive || [];
          targetData.forEach((item) => {
            if (item.store) stores.add(item.store);
          });
          return Array.from(stores).sort();
        }, [archive, nameFilter]);

        const filtered = (archive || []).filter((item) => {
          if (!item || (!item.details && !item.store && !item.name))
            return false;

          const matchName = !nameFilter || item.name === nameFilter;
          const matchStore = !storeFilter || item.store === storeFilter;
          if (!matchName || !matchStore) return false;

          if (!search.trim()) return true;

          // ã‚¹ãƒšãƒ¼ã‚¹ï¼ˆåŠè§’ãƒ»å…¨è§’ï¼‰ã§åˆ†å‰²ã—ã¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰é…åˆ—ã‚’ä½œæˆ
          const keywords = search
            .trim()
            .toLowerCase()
            .split(/[\sã€€]+/)
            .filter(Boolean);
          const searchableText =
            `${item.details} ${item.store} ${item.name} ${item.date}`.toLowerCase();

          // ã™ã¹ã¦ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ (ANDæ¤œç´¢)
          return keywords.every((kw) => searchableText.includes(kw));
        });

        // ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        const HighlightText = ({ text, query }) => {
          if (!query.trim() || !text) return <span>{text}</span>;

          const keywords = query
            .trim()
            .split(/[\sã€€]+/)
            .filter(Boolean);
          if (keywords.length === 0) return <span>{text}</span>;

          // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ­£è¦è¡¨ç¾ç”¨ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦çµåˆ
          const escapedKeywords = keywords.map((kw) =>
            kw.replace(/[.*+?^${}()|[\]\s\\]/g, "\\$&")
          );
          const regex = new RegExp(`(${escapedKeywords.join("|")})`, "gi");

          const parts = String(text).split(regex);
          const lowerKeywords = keywords.map((kw) => kw.toLowerCase());

          return (
            <span>
              {parts.map((part, i) =>
                lowerKeywords.includes(part.toLowerCase()) ? (
                  <span
                    key={i}
                    className="bg-yellow-200 border-b-2 border-yellow-400 font-bold px-0.5 rounded-sm"
                  >
                    {part}
                  </span>
                ) : (
                  part
                )
              )}
            </span>
          );
        };

        // å„è¡Œã‚’è§£æã—ã¦æœŸå¾…å€¤ã‚’ç®—å‡ºã™ã‚‹é–¢æ•°ï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é€£å‹•å¯¾å¿œï¼‰
        const analyzeLine = (line, metadata, lineIndex) => {
          if (!line) return null;
          const dict = window.LATEST_DICT || [];
          const master = window.HOKUTO_MASTER?.["è¨­å®šï¼‘ç›¸å½“"] || {};

          // ã€ä¿®æ­£ã€‘ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆäº‹å‰ã«è¨ˆç®—ä¿å­˜ã•ã‚ŒãŸå†…è¨³ï¼‰ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
          let meta = [];
          if (metadata) {
            try {
              if (typeof metadata === "string") {
                if (metadata.startsWith("[") || metadata.startsWith("{")) {
                  meta = JSON.parse(metadata);
                } else {
                  // ç°¡æ˜“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (æ©Ÿç¨®:æœŸå¾…å€¤)
                  meta = metadata
                    .split("\n")
                    .map((m) => {
                      const parts = m.split(":");
                      return parts.length >= 2
                        ? {
                            machine: parts[0].trim(),
                            ev: parseInt(parts[1].replace(/[^\d-]/g, "")) || 0,
                            line: m.trim(),
                          }
                        : null;
                    })
                    .filter(Boolean);
                }
              } else {
                meta = metadata;
              }

              if (Array.isArray(meta)) {
                // 1. æ–‡è¨€ã§ã®ãƒãƒƒãƒãƒ³ã‚°
                let match = meta.find(
                  (m) =>
                    m &&
                    m.machine &&
                    (m.line === line || line.includes(m.machine))
                );

                // 2. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ã®ãƒãƒƒãƒãƒ³ã‚° (ã‚¹ãƒ—ã‚·ç›´æ¥ç·¨é›†å¯¾å¿œ)
                if (!match && lineIndex !== undefined && meta[lineIndex]) {
                  match = meta[lineIndex];
                }

                if (match) return { machine: match.machine, ev: match.ev };
              }
            } catch (e) {
              console.warn("Metadata parse error", e);
            }
          }

          const found = dict.find((d) => {
            const keywords = (d.ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ || "")
              .split(/[,ï¼Œã€]/)
              .map((k) => k.trim())
              .filter(Boolean);
            return keywords.some((k) => line.includes(k));
          });

          if (!found) {
            // ã€Gemini ææ¡ˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‘é‡‘é¡ã‚‰ã—ãæ–‡å­—åˆ—ãŒã‚ã‚Œã°æ‹¾ã†
            const moneyMatch = line
              .replace(/[ï¼‹]/g, "+")
              .replace(/[ï¼ãƒ¼â€•ãƒ¼âˆ’âˆ’â€-]/g, "-")
              .match(/([+-]?\d+)(?:å††|ev|EV)/i);
            if (moneyMatch) {
              return { machine: "ä¸æ˜æ©Ÿç¨®", ev: parseInt(moneyMatch[1]) };
            }
            return null;
          }

          let ev = 0;
          let machine = found.æ©Ÿç¨®å;

          // ç¬¦å·ã®æ­£è¦åŒ–
          const normLine = line
            .replace(/[ï¼‹]/g, "+")
            .replace(/[ï¼ãƒ¼â€•ãƒ¼âˆ’âˆ’â€-]/g, "-");
          const allNums = (normLine.match(/-?\d+/g) || []).map(Number);

          if (machine === "ã‚¹ãƒã‚¹ãƒ­åŒ—æ–—ã®æ‹³") {
            const gMatch = normLine.match(/(\d+)\s*[Gg]/);
            const sMatch = normLine.match(/([+-]?\d+)\s*[æšæš]/);
            const gCount = gMatch ? parseInt(gMatch[1]) : allNums[0] || 0;
            const diff = sMatch ? parseInt(sMatch[1]) : allNums[1] || 0;

            const getRangeName = (d) => {
              if (d < -1400) return "-1400æšæœªæº€";
              if (d <= -1001) return "-1400ï½-1001æš";
              if (d <= -601) return "-1000ï½-601æš";
              if (d <= -401) return "-600ï½-401æš";
              if (d <= -301) return "-400ï½-301æš";
              if (d <= -201) return "-300ï½-201æš";
              if (d <= -101) return "-200ï½-101æš";
              if (d <= -1) return "-100ï½-1æš";
              if (d <= 99) return "Â±0ï½+99æš";
              if (d <= 199) return "+100ï½+199æš";
              if (d <= 299) return "+200ï½+299æš";
              if (d <= 399) return "+300ï½+399æš";
              if (d <= 599) return "+400ï½+599æš";
              if (d <= 799) return "+600ï½+799æš";
              if (d <= 999) return "+800ï½+999æš";
              if (d <= 1199) return "+1000ï½+1199æš";
              if (d <= 1399) return "+1200ï½+1399æš";
              if (d <= 1999) return "+1400ï½+1999æš";
              return "+2000æšä»¥ä¸Š";
            };
            const targetName = getRangeName(diff);
            const normalize = (k) =>
              String(k || "")
                .replace(/[Â±æšï¼ˆï¼‰()\[\]\sã€€]/g, "")
                .replace(/[ã€œã€œ~]/g, "ï½")
                .trim();
            const normTarget = normalize(targetName);
            const selected = Object.keys(master || {}).find(
              (sh) => normalize(sh) === normTarget
            );
            if (selected && master)
              ev = matchEvInRange(gCount, master[selected]);
          } else {
            // ã€Gemini ææ¡ˆã€‘åŒ—æ–—ä»¥å¤–ã§ã‚‚é‡‘é¡ãŒæ˜è¨˜ã•ã‚Œã¦ã„ã‚Œã°æ‹¾ã†
            const moneyMatch = normLine.match(/([+-]?\d+)(?:å††|ev|EV)/i);
            if (moneyMatch) {
              ev = parseInt(moneyMatch[1]);
            } else {
              ev = 0;
            }
          }

          return { machine: machine || "ä¸æ˜", ev: ev || 0 };
        };

        return (
          <div className="fixed inset-0 z-[110] flex items-center justify-center p-0 md:p-4 bg-slate-900/95 backdrop-blur-md animate-fadeIn text-slate-900">
            <div className="bg-white md:rounded-[3rem] w-full max-w-6xl h-full md:h-[90vh] flex flex-col shadow-2xl overflow-hidden">
              <div className="px-4 py-3 md:p-8 border-b border-slate-100 flex items-center bg-slate-50 shrink-0 gap-3 relative">
                <div className="flex items-center gap-2 md:gap-4 flex-1">
                  <div className="w-8 h-8 md:w-12 md:h-12 bg-indigo-600 rounded-xl flex items-center justify-center text-lg md:text-2xl shadow-lg shrink-0">
                    ğŸ“š
                  </div>
                  <div className="hidden sm:block">
                    <h2 className="text-sm md:text-xl font-black italic text-slate-900 uppercase tracking-tighter leading-none">
                      Archive
                    </h2>
                  </div>
                  <div className="flex-1 max-w-sm relative group">
                    <span className="absolute left-4 top-1/2 -translate-y-1/2 opacity-30 text-xs">
                      ğŸ”
                    </span>
                    <input
                      value={search}
                      onChange={(e) => setSearch(e.target.value)}
                      className="w-full bg-white border border-slate-200 pl-9 pr-4 py-2 rounded-full text-[10px] md:text-xs font-bold outline-none focus:border-indigo-500 transition-all shadow-sm"
                      placeholder="å†…å®¹æ¤œç´¢..."
                    />
                  </div>
                  <div className="flex flex-wrap gap-1 md:gap-2">
                    <select
                      value={nameFilter}
                      onChange={(e) => setNameFilter(e.target.value)}
                      className="bg-white border border-slate-200 px-2 md:px-3 py-1.5 md:py-2 rounded-xl text-[8px] md:text-[10px] font-bold outline-none focus:border-indigo-500 max-w-[80px] md:max-w-none"
                    >
                      <option value="">å…¨å“¡</option>
                      {nameList.map((n) => (
                        <option key={n} value={n}>
                          {n}
                        </option>
                      ))}
                    </select>
                    <select
                      value={storeFilter}
                      onChange={(e) => setStoreFilter(e.target.value)}
                      className="bg-white border border-slate-200 px-2 md:px-3 py-1.5 md:py-2 rounded-xl text-[8px] md:text-[10px] font-bold outline-none focus:border-indigo-500 max-w-[80px] md:max-w-none"
                    >
                      <option value="">å…¨åº—</option>
                      {storeList.map((s) => (
                        <option key={s} value={s}>
                          {s}
                        </option>
                      ))}
                    </select>
                  </div>
                </div>
                <button
                  onClick={onClose}
                  className="w-8 h-8 flex items-center justify-center text-slate-300 hover:text-rose-500 text-xl transition-colors font-black"
                >
                  âœ•
                </button>
              </div>

              <div className="flex-1 overflow-y-auto p-3 md:p-8 custom-scroll bg-slate-50/50">
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-6">
                  {filtered.length > 0 ? (
                    filtered.map((item, idx) => (
                      <div
                        key={idx}
                        className="bg-white p-5 md:p-8 rounded-[1.5rem] md:rounded-[2.5rem] border border-slate-100 shadow-sm hover:shadow-md transition-all group animate-fadeIn"
                      >
                        <div className="flex justify-between items-start mb-4 md:mb-6">
                          <div className="flex-1 min-w-0">
                            <h3 className="text-sm md:text-base font-black italic tracking-tight text-slate-900 flex items-center justify-between gap-4">
                              <span className="truncate max-w-[65%]">
                                <HighlightText
                                  text={item.name}
                                  query={search}
                                />
                              </span>
                              <span className="bg-slate-100 text-slate-800 text-[8px] md:text-[9px] px-3 py-1 rounded-full font-black border border-slate-200 shrink-0 opacity-70 font-mono tracking-tighter">
                                <HighlightText
                                  text={item.date || "æ—¥ä»˜æœªè¨­å®š"}
                                  query={search}
                                />
                              </span>
                            </h3>
                          </div>
                        </div>
                        <div className="space-y-3 md:space-y-4">
                          <div className="flex items-center gap-2">
                            <span className="text-[10px]">ğŸ“</span>
                            <span className="text-[10px] md:text-[11px] font-black text-slate-500 uppercase">
                              <HighlightText text={item.store} query={search} />
                            </span>
                          </div>
                          <div className="bg-slate-50 p-4 md:p-6 rounded-xl md:rounded-2xl border border-slate-100 space-y-3 md:space-y-4">
                            {String(item.details || "")
                              .split("\n")
                              .filter(Boolean)
                              .map((line, lIdx) => {
                                const analysis = analyzeLine(
                                  line,
                                  item.metadata,
                                  lIdx // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¸¡ã™
                                );
                                return (
                                  <div
                                    key={lIdx}
                                    className="space-y-1 pb-2 md:pb-3 border-b border-slate-200/50 last:border-0 last:pb-0"
                                  >
                                    {analysis && (
                                      <div className="text-[9px] font-black text-purple-600 uppercase tracking-tighter flex items-center gap-1.5">
                                        <span className="w-1 h-1 rounded-full bg-purple-400"></span>
                                        {analysis.machine}
                                      </div>
                                    )}
                                    <div className="flex justify-between items-start gap-2">
                                      <div className="text-[10px] md:text-[11px] font-bold text-slate-600 leading-relaxed flex-1">
                                        <HighlightText
                                          text={line}
                                          query={search}
                                        />
                                      </div>
                                      {analysis && (
                                        <div className="text-[10px] font-black text-[#0076FF] italic shrink-0">
                                          {analysis.ev !== 0
                                            ? `${
                                                analysis.ev > 0 ? "+" : ""
                                              }${analysis.ev.toLocaleString()}å††`
                                            : "---"}
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                );
                              })}
                          </div>
                          <div className="px-2 pt-4 border-t border-slate-100 space-y-3">
                            <div className="flex items-center justify-between">
                              <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                ç·æœŸå¾…å€¤
                              </div>
                              <div className="text-xl font-black italic text-[#0076FF] tracking-tighter drop-shadow-sm">
                                {(item.ev || 0).toLocaleString()}{" "}
                                <span className="text-xs">å††</span>
                              </div>
                            </div>
                            <div className="flex items-center justify-between pt-1 border-t border-dashed border-slate-100">
                              <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                å‰å›æ¯”è¼ƒå®Ÿåæ”¯
                              </div>
                              <div
                                className={`text-xl font-black italic tracking-tighter drop-shadow-sm ${
                                  item.profit >= 0
                                    ? "text-[#00FF85]"
                                    : "text-rose-500"
                                }`}
                              >
                                {(item.profit || 0).toLocaleString()}{" "}
                                <span className="text-xs">å††</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    ))
                  ) : (
                    <div className="col-span-full py-40 text-center space-y-4">
                      <div className="text-6xl opacity-20">ğŸ•³ï¸</div>
                      <p className="text-slate-300 font-black italic uppercase tracking-widest">
                        No matches found in library
                      </p>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      }

      function MasterConsole({
        dictionary,
        strategyData,
        resetMaster: initialResetMaster,
        onSave,
        onClose,
      }) {
        const [tab, setTab] = useState("dict");
        const [search, setSearch] = useState("");
        const [dictItems, setDictItems] = useState([...dictionary]);
        const [stData, setStData] = useState([...strategyData]);
        const [rsMaster, setRsMaster] = useState([...initialResetMaster]);
        const [loading, setLoading] = useState(false);
        const handleSave = async () => {
          setLoading(true);
          try {
            const payload = {
              action: "saveMasterAll",
              data: {},
            };
            if (tab === "dict") payload.data.dictionary = dictItems;
            if (tab === "strategy") payload.data.strategy = stData;
            if (tab === "reset") payload.data.reset = rsMaster;

            await fetch(GAS_URL, {
              method: "POST",
              mode: "no-cors",
              body: JSON.stringify(payload),
            });
            alert("ä¿å­˜ã—ã¾ã—ãŸ");
            onSave({
              dictionary: tab === "dict" ? dictItems : dictionary,
              strategy: tab === "strategy" ? stData : strategyData,
              reset: tab === "reset" ? rsMaster : initialResetMaster,
            });
          } catch (e) {
            alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + e.message);
          } finally {
            setLoading(false);
          }
        };
        return (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/90 backdrop-blur-sm animate-fadeIn">
            <div className="bg-white rounded-[3rem] w-full max-w-5xl h-[85vh] flex flex-col shadow-2xl overflow-hidden">
              <div className="p-8 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center bg-slate-50 shrink-0 gap-4">
                <h2 className="text-2xl font-black italic text-slate-900 uppercase">
                  Master Console ğŸ“–
                </h2>
                <div className="flex-1 max-w-md w-full relative group">
                  <span className="absolute left-4 top-1/2 -translate-y-1/2 opacity-30 group-focus-within:opacity-100 transition-opacity">
                    ğŸ”
                  </span>
                  <input
                    value={search}
                    onChange={(e) => setSearch(e.target.value)}
                    className="w-full bg-white border border-slate-200 pl-10 pr-4 py-3 rounded-2xl text-xs font-bold outline-none focus:border-[#0076FF] focus:ring-4 focus:ring-[#0076FF]/5 transition-all"
                    placeholder={`${
                      tab === "dict"
                        ? "æ©Ÿç¨®åãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œç´¢..."
                        : "æ©Ÿç¨®åãƒ»å†…å®¹ã‚’æ¤œç´¢..."
                    }`}
                  />
                </div>
                <div className="flex gap-2 bg-slate-200 p-1 rounded-full w-full md:w-auto overflow-x-auto">
                  {["dict", "strategy", "reset"].map((t) => (
                    <button
                      key={t}
                      onClick={() => setTab(t)}
                      className={`flex-1 md:flex-none px-6 py-3 rounded-full text-[10px] font-black transition-all whitespace-nowrap ${
                        tab === t
                          ? "bg-[#0076FF] text-white shadow-md font-black"
                          : "text-slate-500 hover:text-slate-700"
                      }`}
                    >
                      {t === "dict"
                        ? "æ©Ÿç¨®è¾æ›¸"
                        : t === "strategy"
                        ? "æ”»ç•¥ãƒ»ç‹™ã„ç›®"
                        : "æœä¸€å°"}
                    </button>
                  ))}
                </div>
                <button
                  onClick={onClose}
                  className="absolute top-4 right-8 text-slate-400 hover:text-rose-500 text-3xl transition-colors"
                >
                  âœ•
                </button>
              </div>
              <div className="flex-1 overflow-y-auto p-8 custom-scroll">
                {tab === "dict" && (
                  <div className="space-y-4">
                    <button
                      onClick={() =>
                        setDictItems([
                          {
                            æ©Ÿç¨®å: "",
                            ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: "",
                            è‰²ã‚³ãƒ¼ãƒ‰: "bg-slate-400",
                          },
                          ...dictItems,
                        ])
                      }
                      className="w-full py-4 border-2 border-dashed border-[#0076FF] text-[#0076FF] font-black rounded-2xl mb-4"
                    >
                      + æ–°æ©Ÿè¾æ›¸ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ 
                    </button>
                    {dictItems
                      .map((it, idx) => ({ it, idx }))
                      .filter(
                        ({ it }) =>
                          !search ||
                          it.æ©Ÿç¨®å.includes(search) ||
                          it.ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰.includes(search)
                      )
                      .map(({ it, idx }) => (
                        <div
                          key={idx}
                          className="bg-slate-50 p-6 rounded-3xl border border-slate-100 space-y-4 relative group"
                        >
                          <div className="flex flex-col md:flex-row gap-4">
                            <div className="flex-1">
                              <label className="text-[8px] font-black text-slate-400 uppercase ml-2 mb-1 block">
                                æ©Ÿç¨®å
                              </label>
                              <input
                                value={it.æ©Ÿç¨®å}
                                onChange={(e) => {
                                  const n = [...dictItems];
                                  n[idx].æ©Ÿç¨®å = e.target.value;
                                  setDictItems(n);
                                }}
                                className="w-full bg-white px-4 py-3 rounded-xl font-black text-sm outline-none border border-slate-200"
                                placeholder="æ©Ÿç¨®å"
                              />
                            </div>
                            <div className="w-full md:w-40">
                              <label className="text-[8px] font-black text-slate-400 uppercase ml-2 mb-1 block">
                                è‰²ã‚³ãƒ¼ãƒ‰
                              </label>
                              <select
                                value={it.è‰²ã‚³ãƒ¼ãƒ‰}
                                onChange={(e) => {
                                  const n = dictItems.map((item, i) =>
                                    i === idx
                                      ? { ...item, è‰²ã‚³ãƒ¼ãƒ‰: e.target.value }
                                      : item
                                  );
                                  setDictItems(n);
                                }}
                                className="w-full bg-white px-4 py-3 rounded-xl text-[10px] font-black border border-slate-200"
                              >
                                <option value="bg-indigo-600">INDIGO</option>
                                <option value="bg-rose-600">ROSE</option>
                                <option value="bg-emerald-600">EMERALD</option>
                                <option value="bg-orange-500">ORANGE</option>
                                <option value="bg-blue-600">BLUE</option>
                                <option value="bg-slate-400">SLATE</option>
                              </select>
                            </div>
                          </div>
                          <div>
                            <label className="text-[8px] font-black text-slate-400 uppercase ml-2 mb-1 block">
                              ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)
                            </label>
                            <input
                              value={it.ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰}
                              onChange={(e) => {
                                const n = dictItems.map((item, i) =>
                                  i === idx
                                    ? { ...item, ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: e.target.value }
                                    : item
                                );
                                setDictItems(n);
                              }}
                              className="w-full bg-white px-4 py-3 rounded-xl text-xs font-bold outline-none border border-slate-200"
                              placeholder="ä¾‹: åŒ—æ–—,ã»ãã¨,æ‹³"
                            />
                          </div>
                          <button
                            onClick={() => {
                              if (
                                window.confirm(
                                  `${
                                    it.æ©Ÿç¨®å || "ã“ã‚Œ"
                                  } ã‚’è¾æ›¸ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`
                                )
                              )
                                setDictItems(
                                  dictItems.filter((_, i) => i !== idx)
                                );
                            }}
                            className="absolute top-4 right-4 text-slate-300 hover:text-rose-500 font-black text-xl"
                          >
                            âœ•
                          </button>
                        </div>
                      ))}
                  </div>
                )}
                {tab === "strategy" && (
                  <div className="space-y-4">
                    <button
                      onClick={() =>
                        setStData([
                          { æ©Ÿç¨®å: "", ç‹™ã„ç›®: "", URL: "" },
                          ...stData,
                        ])
                      }
                      className="w-full py-4 border-2 border-dashed border-[#0076FF] text-[#0076FF] font-black rounded-2xl mb-4"
                    >
                      + æ–°è¦æ”»ç•¥æƒ…å ±ã‚’è¿½åŠ 
                    </button>
                    {stData
                      .map((it, idx) => ({ it, idx }))
                      .filter(
                        ({ it }) =>
                          !search ||
                          it.æ©Ÿç¨®å.includes(search) ||
                          it.ç‹™ã„ç›®.includes(search)
                      )
                      .map(({ it, idx }) => (
                        <div
                          key={idx}
                          className="bg-slate-50 p-6 rounded-3xl border border-slate-100 flex gap-4 items-start group"
                        >
                          <div className="flex-1 space-y-4">
                            <input
                              value={it.æ©Ÿç¨®å}
                              onChange={(e) => {
                                const n = stData.map((item, i) =>
                                  i === idx
                                    ? { ...item, æ©Ÿç¨®å: e.target.value }
                                    : item
                                );
                                setStData(n);
                              }}
                              className="w-full bg-white px-4 py-3 rounded-xl font-black text-sm outline-none border border-slate-200"
                              placeholder="æ©Ÿç¨®å"
                            />
                            <textarea
                              value={it.ç‹™ã„ç›®}
                              onChange={(e) => {
                                const n = stData.map((item, i) =>
                                  i === idx
                                    ? { ...item, ç‹™ã„ç›®: e.target.value }
                                    : item
                                );
                                setStData(n);
                              }}
                              className="w-full bg-white px-4 py-3 rounded-xl text-xs font-medium outline-none border border-slate-200 min-h-[100px]"
                              placeholder="ç‹™ã„ç›®ãƒ»ã‚„ã‚ã©ãç­‰ã®è§£èª¬"
                            />
                            <input
                              value={it.URL}
                              onChange={(e) => {
                                const n = [...stData];
                                n[idx].URL = e.target.value;
                                setStData(n);
                              }}
                              className="w-full bg-white px-4 py-3 rounded-xl text-[10px] outline-none border border-slate-200"
                              placeholder="è§£æã‚µã‚¤ãƒˆURL"
                            />
                          </div>
                          <button
                            onClick={() => {
                              if (
                                window.confirm(
                                  `${
                                    it.æ©Ÿç¨®å || "ã“ã‚Œ"
                                  } ã®æ”»ç•¥æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`
                                )
                              )
                                setStData(stData.filter((_, i) => i !== idx));
                            }}
                            className="text-slate-300 hover:text-rose-500 font-black"
                          >
                            âœ•
                          </button>
                        </div>
                      ))}
                  </div>
                )}
                {tab === "reset" && (
                  <div className="space-y-6">
                    <div className="flex justify-between items-center mb-8 bg-rose-50 p-6 rounded-[2rem] border border-rose-100">
                      <div>
                        <h3 className="text-sm font-black text-rose-900 italic">
                          æœä¸€å°ãƒã‚¹ã‚¿
                        </h3>
                        <p className="text-[10px] font-bold text-rose-400 mt-1 uppercase font-black">
                          Keywords are used for multiplier detection (e.g. Ã—3).
                          Dictionary keywords are also used automatically.
                        </p>
                      </div>
                      <button
                        onClick={() =>
                          setRsMaster([
                            ...rsMaster,
                            {
                              æ©Ÿç¨®å: "",
                              ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: "ãƒªã‚»,æœä¸€",
                              å˜ä¾¡: 800,
                              å‚™è€ƒ: "",
                            },
                          ])
                        }
                        className="bg-white text-rose-600 border border-rose-200 px-6 py-3 rounded-2xl text-[10px] font-black hover:bg-rose-50 transition-all shadow-sm"
                      >
                        + æ–°è¦è¨­å®šè¿½åŠ 
                      </button>
                    </div>
                    {rsMaster.map((it, idx) => (
                      <div
                        key={idx}
                        className="bg-slate-50 p-8 rounded-[2.5rem] border border-slate-100 space-y-6 relative group"
                      >
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <div>
                            <label className="text-[8px] font-black text-slate-400 uppercase ml-2 mb-1 block">
                              å¯¾è±¡æ©Ÿç¨®å (ãƒã‚¹ã‚¿ç…§åˆç”¨)
                            </label>
                            <input
                              value={it.æ©Ÿç¨®å}
                              onChange={(e) => {
                                const n = rsMaster.map((item, i) =>
                                  i === idx
                                    ? { ...item, æ©Ÿç¨®å: e.target.value }
                                    : item
                                );
                                setRsMaster(n);
                              }}
                              className="w-full bg-white px-4 py-3 rounded-xl font-black text-sm outline-none border border-slate-200"
                              placeholder="åŒ—æ–—, ã‚«ãƒãƒãƒªãªã©"
                            />
                          </div>
                          <div>
                            <label className="text-[8px] font-black text-slate-400 uppercase ml-2 mb-1 block">
                              æœŸå¾…å€¤å˜ä¾¡ (å††)
                            </label>
                            <input
                              type="number"
                              value={it.å˜ä¾¡}
                              onChange={(e) => {
                                const n = rsMaster.map((item, i) =>
                                  i === idx
                                    ? {
                                        ...item,
                                        å˜ä¾¡: parseInt(e.target.value) || 0,
                                      }
                                    : item
                                );
                                setRsMaster(n);
                              }}
                              className="w-full bg-white px-4 py-3 rounded-xl font-black text-sm outline-none border border-slate-200 text-rose-600"
                              placeholder="800"
                            />
                          </div>
                        </div>
                        <div>
                          <label className="text-[8px] font-black text-slate-400 uppercase ml-2 mb-1 block">
                            åå¿œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)
                          </label>
                          <input
                            value={it.ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰}
                            onChange={(e) => {
                              const n = rsMaster.map((item, i) =>
                                i === idx
                                  ? { ...item, ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: e.target.value }
                                  : item
                              );
                              setRsMaster(n);
                            }}
                            className="w-full bg-white px-4 py-3 rounded-xl text-xs font-bold outline-none border border-slate-200"
                            placeholder="ä¾‹: æœä¸€,ãƒªã‚»,å¤‰æ›´"
                          />
                        </div>
                        <button
                          onClick={() => {
                            if (window.confirm("ã“ã®è¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                              setRsMaster(rsMaster.filter((_, i) => i !== idx));
                            }
                          }}
                          className="absolute -top-2 -right-2 w-8 h-8 bg-white border border-slate-200 text-slate-300 rounded-full flex items-center justify-center hover:bg-rose-50 hover:text-rose-500 hover:border-rose-200 transition-all opacity-0 group-hover:opacity-100 shadow-sm"
                        >
                          âœ•
                        </button>
                      </div>
                    ))}
                  </div>
                )}
              </div>
              <div className="p-8 border-t border-slate-100 bg-slate-50 shrink-0">
                <button
                  onClick={handleSave}
                  disabled={loading}
                  className={`w-full py-5 rounded-[2rem] text-white font-black shadow-xl active:scale-95 transition-all uppercase tracking-widest text-xs ${
                    tab === "reset" ? "bg-rose-600" : "bg-[#0076FF]"
                  }`}
                >
                  {loading
                    ? "ä¿å­˜ä¸­..."
                    : `${
                        tab === "dict"
                          ? "æ©Ÿç¨®è¾æ›¸"
                          : tab === "strategy"
                          ? "æ”»ç•¥æƒ…å ±"
                          : "æœä¸€å°ãƒã‚¹ã‚¿"
                      }ã‚’ä¿å­˜`}
                </button>
              </div>
            </div>
          </div>
        );
      }

      function SecurityHub({ onClose }) {
        const [activeTab, setActiveTab] = useState("logs");
        const [logs, setLogs] = useState([]);
        const [blacklist, setBlacklist] = useState([]);
        const [members, setMembers] = useState([]);
        const [stores, setStores] = useState([]);
        const [settings, setSettings] = useState({ registrationLocked: false });
        const [loading, setLoading] = useState(false);

        useEffect(() => {
          load();
        }, []);

        const load = async () => {
          setLoading(true);
          try {
            const fetchSafe = async (action, defaultVal = []) => {
              try {
                const res = await fetch(`${GAS_URL}?action=${action}`);
                if (!res.ok) throw new Error(`HTTP error ${res.status}`);
                return await res.json();
              } catch (e) {
                console.error(`Failed to fetch ${action}:`, e);
                return defaultVal;
              }
            };

            const [hData, bData, sData, mData, stData] = await Promise.all([
              fetchSafe("getAccessHistory", []),
              fetchSafe("getBlacklist", []),
              fetchSafe("getSettings", { registrationLocked: false }),
              fetchSafe("getMembers", []), // ã“ã“ã§ãƒ¡ãƒ³ãƒãƒ¼ãƒã‚¹ã‚¿ã‚’å–å¾—
              fetchSafe("getStores", []),
            ]);

            setLogs(hData);
            setBlacklist(bData);
            setSettings(sData);
            setMembers(mData);
            setStores(stData);
          } catch (e) {
            console.error("Critical load error:", e);
          } finally {
            setLoading(false);
          }
        };
        const saveBan = async () => {
          setLoading(true);
          try {
            await fetch(GAS_URL, {
              method: "POST",
              mode: "no-cors",
              body: JSON.stringify({
                action: "saveBlacklist",
                data: blacklist,
              }),
            });
            alert("ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ");
          } catch (e) {
            alert(e.message);
          } finally {
            setLoading(false);
          }
        };

        const saveMembers = async () => {
          setLoading(true);
          try {
            await fetch(GAS_URL, {
              method: "POST",
              mode: "no-cors",
              body: JSON.stringify({ action: "saveMembers", data: members }),
            });
            alert(
              "ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚æ–°è¦ç™»éŒ²ãƒ­ãƒƒã‚¯æœ‰åŠ¹æ™‚ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚"
            );
          } catch (e) {
            alert(e.message);
          } finally {
            setLoading(false);
          }
        };

        const handleRename = async (oldName) => {
          const newName = prompt(
            `ã€Œ${oldName}ã€ã•ã‚“ã®æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`
          );
          if (!newName || newName === oldName) return;

          if (
            confirm(
              `ã€é‡è¦ã€‘åå‰ã‚’ã€Œ${newName}ã€ã«å¤‰æ›´ã—ã¾ã™ã€‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå…¨åŸŸã®ãƒ­ã‚°ãŒç½®æ›ã•ã‚Œã€ãƒ¯ãƒ¼ã‚«ãƒ¼å´ã®ã‚¢ãƒ—ãƒªã‚‚è‡ªå‹•çš„ã«åŒæœŸã•ã‚Œã¾ã™ã€‚å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`
            )
          ) {
            setLoading(true);
            try {
              await fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify({
                  action: "renameMember",
                  data: { oldName, newName },
                }),
              });
              alert("åå‰ä¿®æ­£ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚åæ˜ ã¾ã§æ•°ç§’ã‹ã‹ã‚Šã¾ã™ã€‚");
              load();
            } catch (e) {
              alert(e.message);
            } finally {
              setLoading(false);
            }
          }
        };

        const handleDeleteMember = async (targetName) => {
          if (
            confirm(
              `ã€è­¦å‘Šã€‘ã€Œ${targetName}ã€ã•ã‚“ã‚’ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‹ã‚‰å®Œå…¨ã«æŠ¹æ¶ˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´ã‹ã‚‰å‰Šé™¤ã•ã‚Œã€ä»¥é™ç®¡ç†ç”»é¢ã«è¡¨ç¤ºã•ã‚Œãªããªã‚Šã¾ã™ã€‚éå»ã®ç¨¼å‹•ãƒ­ã‚°ã¯ãã®ã¾ã¾æ®‹ã‚Šã¾ã™ï¼‰`
            )
          ) {
            setLoading(true);
            try {
              await fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify({
                  action: "deleteMember",
                  data: { targetName },
                }),
              });
              alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
              load();
            } catch (e) {
              alert(e.message);
            } finally {
              setLoading(false);
            }
          }
        };
        return (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/90 backdrop-blur-sm animate-fadeIn">
            <div className="bg-white rounded-[3rem] md:rounded-[4rem] w-full max-w-6xl h-[90vh] flex flex-col shadow-2xl overflow-hidden border-4 border-white">
              <div className="p-8 md:p-10 border-b border-slate-100 flex flex-col lg:flex-row justify-between items-center bg-slate-50 shrink-0 gap-6 relative">
                <div className="flex items-center gap-6">
                  <div className="w-16 h-16 bg-slate-900 rounded-[2rem] flex items-center justify-center text-3xl shadow-xl">
                    ğŸ›¡ï¸
                  </div>
                  <div>
                    <h2 className="text-3xl font-black italic text-slate-900 uppercase tracking-tighter">
                      Security Hub
                    </h2>
                    <p className="text-[10px] text-slate-400 font-bold uppercase tracking-[0.3em] mt-1">
                      Admin Security & Operation Control
                    </p>
                  </div>
                </div>
                <div className="flex gap-2 bg-slate-200 p-1.5 rounded-full w-full lg:w-auto overflow-x-auto custom-scroll no-scrollbar">
                  <button
                    onClick={() => setActiveTab("logs")}
                    className={`flex-1 py-4 text-[10px] font-black tracking-widest transition-all ${
                      activeTab === "logs"
                        ? "bg-[#0076FF] text-white shadow-lg"
                        : "text-slate-500 hover:text-white"
                    }`}
                  >
                    å®‰å…¨ãƒ­ã‚°
                  </button>
                  <button
                    onClick={() => setActiveTab("members")}
                    className={`flex-1 py-4 text-[10px] font-black tracking-widest transition-all ${
                      activeTab === "members"
                        ? "bg-[#0076FF] text-white shadow-lg"
                        : "text-slate-500 hover:text-white"
                    }`}
                  >
                    ãƒ¡ãƒ³ãƒãƒ¼åç°¿
                  </button>
                  <button
                    onClick={() => setActiveTab("blacklist")}
                    className={`flex-1 py-4 text-[10px] font-black tracking-widest transition-all ${
                      activeTab === "blacklist"
                        ? "bg-[#0076FF] text-white shadow-lg"
                        : "text-slate-500 hover:text-white"
                    }`}
                  >
                    ç¦æ­¢è¨­å®š
                  </button>
                  <button
                    onClick={() => setActiveTab("stores")}
                    className={`flex-1 py-4 text-[10px] font-black tracking-widest transition-all ${
                      activeTab === "stores"
                        ? "bg-[#0076FF] text-white shadow-lg"
                        : "text-slate-500 hover:text-white"
                    }`}
                  >
                    åº—èˆ—è¨­å®š
                  </button>
                  <button
                    onClick={() => setActiveTab("system")}
                    className={`flex-1 py-4 text-[10px] font-black tracking-widest transition-all ${
                      activeTab === "system"
                        ? "bg-[#0076FF] text-white shadow-lg"
                        : "text-slate-500 hover:text-white"
                    }`}
                  >
                    ã‚·ã‚¹ãƒ†ãƒ é˜²å£
                  </button>
                </div>
                <button
                  onClick={onClose}
                  className="hidden lg:block text-slate-300 hover:text-rose-500 text-4xl transition-colors font-light"
                >
                  âœ•
                </button>
                <button
                  onClick={load}
                  className="absolute top-4 right-20 text-indigo-400 hover:text-indigo-600 text-sm font-black p-2 animate-pulse"
                >
                  {loading ? "SYNCING..." : "ğŸ”„ REFRESH"}
                </button>
              </div>

              <div className="flex-1 overflow-y-auto p-4 md:p-10 custom-scroll space-y-8 bg-slate-50/50">
                {activeTab === "logs" ? (
                  <div className="space-y-3">
                    <div className="px-4 mb-2 flex justify-between items-center">
                      <h3 className="text-xs font-black uppercase text-slate-400 tracking-widest">
                        è¿‘æ—¥ä¸­ã®ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´ (100ä»¶)
                      </h3>
                    </div>
                    {logs.length > 0 ? (
                      logs.map((L, i) => (
                        <div
                          key={i}
                          className="flex justify-between items-center bg-white p-6 rounded-[1.5rem] border border-slate-100 shadow-sm hover:border-indigo-200 hover:shadow-md transition-all group animate-fadeIn"
                        >
                          <div className="flex gap-6 items-center">
                            <div className="flex flex-col">
                              <span className="text-[9px] font-black text-slate-400 uppercase tracking-tighter mb-1 font-mono">
                                {new Date(L.æ—¥æ™‚).toLocaleString()}
                              </span>
                              <span className="text-sm font-black text-slate-800 italic">
                                {L.åå‰}
                              </span>
                            </div>
                          </div>
                          <span
                            className={`text-[9px] font-black px-4 py-2 rounded-xl shadow-sm ${
                              L.è¡Œå‹•?.includes("æ‰¿èª")
                                ? "bg-emerald-500 text-white"
                                : L.è¡Œå‹•?.includes("é€ä¿¡")
                                ? "bg-indigo-500 text-white"
                                : "bg-slate-100 text-slate-600"
                            }`}
                          >
                            {L.è¡Œå‹•}
                          </span>
                        </div>
                      ))
                    ) : (
                      <div className="text-center py-20 text-slate-300 font-bold italic">
                        No access logs found
                      </div>
                    )}
                  </div>
                ) : activeTab === "blacklist" ? (
                  <div className="max-w-3xl mx-auto space-y-10 py-6 animate-fadeIn">
                    <div className="text-center space-y-3">
                      <h3 className="text-2xl font-black text-rose-600 uppercase italic tracking-tighter">
                        Blacklist Control
                      </h3>
                      <p className="text-xs font-bold text-slate-400">
                        ç™»éŒ²ã•ã‚ŒãŸåå‰ã¯å…¨ã¦ã®ã‚¢ãƒ—ãƒªæ©Ÿèƒ½ãŒé®æ–­ã•ã‚Œã¾ã™
                      </p>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {blacklist.length > 0 ? (
                        blacklist.map((name, i) => (
                          <div
                            key={i}
                            className="flex justify-between items-center bg-white p-6 rounded-3xl border border-rose-100 shadow-sm border-l-4 border-l-rose-500 group"
                          >
                            <span className="font-black text-rose-950 italic text-base">
                              {name}
                            </span>
                            <button
                              onClick={() => {
                                if (
                                  confirm(`${name} ã•ã‚“ã®å‡ºç¦ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ`)
                                )
                                  setBlacklist(
                                    blacklist.filter((n) => n !== name)
                                  );
                              }}
                              className="text-[10px] font-black text-rose-300 hover:text-rose-600 uppercase tracking-widest transition-colors"
                            >
                              REMOVE
                            </button>
                          </div>
                        ))
                      ) : (
                        <div className="col-span-full text-center py-10 text-slate-300 italic font-bold">
                          No restricted members
                        </div>
                      )}
                    </div>
                    <div className="flex gap-4 bg-slate-900/5 p-6 rounded-[2.5rem] border-2 border-dashed border-slate-200 shadow-inner">
                      <input
                        id="banInputSec"
                        className="flex-1 bg-white p-5 rounded-3xl outline-none font-bold text-sm border-2 border-transparent focus:border-rose-400 transition-all shadow-sm"
                        placeholder="å‡ºç¦ã«ã™ã‚‹æ­£ç¢ºãªåå‰ã‚’å…¥åŠ›..."
                      />
                      <button
                        onClick={() => {
                          const v =
                            document.getElementById("banInputSec").value;
                          if (v) setBlacklist([...blacklist, v]);
                          document.getElementById("banInputSec").value = "";
                        }}
                        className="bg-slate-900 text-white px-10 rounded-3xl font-black text-xs uppercase tracking-widest hover:bg-rose-600 transition-all"
                      >
                        è¿½åŠ 
                      </button>
                    </div>
                    <button
                      onClick={saveBan}
                      className="w-full bg-rose-600 py-7 rounded-[2.5rem] text-white font-black shadow-2xl hover:bg-rose-700 active:scale-[0.98] transition-all text-xs tracking-[0.3em] uppercase"
                    >
                      Commit Changes to Server
                    </button>
                  </div>
                ) : activeTab === "stores" ? (
                  <div className="space-y-6 animate-fadeIn">
                    <div className="flex justify-between items-end px-2 mb-8">
                      <div>
                        <h3 className="text-2xl font-black text-slate-800 italic uppercase tracking-tighter leading-none">
                          Store Master
                        </h3>
                        <p className="text-[10px] text-slate-400 font-bold uppercase tracking-[0.2em] mt-3 bg-emerald-50 inline-block px-3 py-1 rounded-lg">
                          Exchange Rate Management
                        </p>
                      </div>
                      <button
                        onClick={() =>
                          setStores([
                            ...stores,
                              {
                                åº—èˆ—å: "",
                                m20: "",
                                m5: "",
                                p4: "",
                                ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: "",
                                æ”»ç•¥ãƒ¡ãƒ¢: "",
                              },
                          ])
                        }
                        className="bg-emerald-600 text-white px-6 py-3 rounded-2xl font-black text-[10px] uppercase shadow-lg hover:bg-emerald-700 transition-all"
                      >
                        + Add Store
                      </button>
                    </div>
                    <div className="grid grid-cols-1 gap-4">
                      {stores.map((s, idx) => (
                        <div
                          key={idx}
                          className="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm flex flex-col md:flex-row gap-4 items-center group"
                        >
                          <div className="flex-1 w-full space-y-3">
                            <input
                              value={s.åº—èˆ—å}
                              onChange={(e) => {
                                const ns = [...stores];
                                ns[idx].åº—èˆ—å = e.target.value;
                                setStores(ns);
                              }}
                              className="w-full bg-slate-50 p-4 rounded-xl font-bold text-sm outline-none focus:bg-white focus:ring-2 focus:ring-emerald-500/20 shadow-inner"
                              placeholder="æ­£å¼åç§° (ä¾‹: ãƒãƒ«ãƒãƒ³é‡å·)"
                            />
                            <input
                              value={s.ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰}
                              onChange={(e) => {
                                const ns = [...stores];
                                ns[idx].ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ = e.target.value;
                                setStores(ns);
                              }}
                              className="w-full bg-slate-50 p-3 rounded-xl font-bold text-[10px] outline-none border border-slate-100 placeholder:text-slate-300 focus:bg-white"
                              placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ä¾‹: é‡å·, nogawa)"
                            />
                            <textarea
                              value={s.æ”»ç•¥ãƒ¡ãƒ¢}
                              onChange={(e) => {
                                const ns = [...stores];
                                ns[idx].æ”»ç•¥ãƒ¡ãƒ¢ = e.target.value;
                                setStores(ns);
                              }}
                              rows="3"
                              className="w-full bg-slate-50 p-4 rounded-[1.5rem] font-medium text-xs outline-none focus:bg-white focus:ring-2 focus:ring-emerald-500/20 border border-slate-100 custom-scroll shadow-inner"
                              placeholder="ã€æ”»ç•¥ãƒ¡ãƒ¢ã€‘æ®ãƒªã‚»çŠ¶æ³ã€ã‚¨ãƒŠ/è»å›£æœ‰ç„¡ã€ãƒ—ãƒ­å¯¾ç­–ã€åº—å“¡å¯¾å¿œãªã©..."
                            />
                          </div>
                          <div className="flex flex-col gap-4 w-full md:w-auto shrink-0">
                            <div className="grid grid-cols-3 gap-2">
                              <div className="relative">
                                <span className="absolute -top-2 left-2 text-[8px] font-black text-rose-500 bg-white px-1">
                                  20ã‚¹ãƒ­
                                </span>
                                <input
                                  value={s.m20}
                                  onChange={(e) => {
                                    const ns = [...stores];
                                    ns[idx].m20 = e.target.value;
                                    setStores(ns);
                                  }}
                                  className="w-full md:w-20 bg-slate-50 p-3 rounded-xl font-mono text-xs text-center border border-slate-100"
                                  placeholder="46"
                                />
                              </div>
                              <div className="relative">
                                <span className="absolute -top-2 left-2 text-[8px] font-black text-indigo-500 bg-white px-1">
                                  5ã‚¹ãƒ­
                                </span>
                                <input
                                  value={s.m5}
                                  onChange={(e) => {
                                    const ns = [...stores];
                                    ns[idx].m5 = e.target.value;
                                    setStores(ns);
                                  }}
                                  className="w-full md:w-20 bg-slate-50 p-3 rounded-xl font-mono text-xs text-center border border-slate-100"
                                  placeholder="178"
                                />
                              </div>
                              <div className="relative">
                                <span className="absolute -top-2 left-2 text-[8px] font-black text-emerald-500 bg-white px-1">
                                  4ãƒ‘ãƒ
                                </span>
                                <input
                                  value={s.p4}
                                  onChange={(e) => {
                                    const ns = [...stores];
                                    ns[idx].p4 = e.target.value;
                                    setStores(ns);
                                  }}
                                  className="w-full md:w-20 bg-slate-50 p-3 rounded-xl font-mono text-xs text-center border border-slate-100"
                                  placeholder="250"
                                />
                              </div>
                            </div>
                            <button
                              onClick={() =>
                                setStores(stores.filter((_, i) => i !== idx))
                              }
                              className="w-full bg-rose-50 text-rose-500 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-rose-100 transition-colors"
                            >
                              DELETE STORE
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                    <button
                      onClick={async () => {
                        setLoading(true);
                        try {
                          await fetch(GAS_URL, {
                            method: "POST",
                            mode: "no-cors",
                            body: JSON.stringify({
                              action: "saveStores",
                              data: stores,
                            }),
                          });
                          alert("åº—èˆ—ãƒã‚¹ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
                        } catch (e) {
                          alert(e.message);
                        } finally {
                          setLoading(false);
                        }
                      }}
                      className="w-full bg-emerald-600 py-7 rounded-[2.5rem] text-white font-black shadow-2xl hover:bg-emerald-700 active:scale-[0.98] transition-all text-xs tracking-[0.3em] uppercase mt-4"
                    >
                      Save Store Settings
                    </button>
                  </div>
                ) : activeTab === "system" ? (
                  <div className="max-w-3xl mx-auto space-y-12 py-6 animate-fadeIn">
                    <div className="bg-slate-900 text-white p-10 rounded-[3.5rem] shadow-2xl relative overflow-hidden group">
                      <div className="relative z-10 flex items-center gap-8">
                        <div className="w-16 h-16 bg-white/10 rounded-2xl flex items-center justify-center text-3xl backdrop-blur-md">
                          âš™ï¸
                        </div>
                        <div>
                          <h3 className="text-2xl font-black italic tracking-tighter">
                            Advanced Control
                          </h3>
                          <p className="text-[10px] text-white/40 font-bold uppercase tracking-[0.3em] mt-1">
                            System parameters & Global config
                          </p>
                        </div>
                      </div>
                      <div className="absolute top-0 right-0 p-10 opacity-10 pointer-events-none transform rotate-12 group-hover:scale-110 transition-transform">
                        <div className="text-9xl font-black italic">SYSTEM</div>
                      </div>
                    </div>

                    <div className="grid grid-cols-1 gap-8">
                      {/* Security Toggles */}
                      <div className="bg-white p-10 rounded-[3rem] border border-slate-200 shadow-sm space-y-8">
                        <div className="flex items-center gap-3 border-b border-slate-100 pb-6 mb-2">
                          <div className="w-2 h-6 bg-rose-500 rounded-full"></div>
                          <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest">
                            Entry Control
                          </h4>
                        </div>
                        <div className="bg-rose-500/10 p-6 rounded-3xl border border-rose-500/20">
                          <div className="flex items-center justify-between mb-2">
                            <h4 className="text-rose-400 font-black text-[10px] uppercase tracking-[0.2em]">
                              æ–°è¦ç™»éŒ²ãƒ­ãƒƒã‚¯
                            </h4>
                            <div
                              onClick={async () => {
                                const newVal = !settings.registrationLocked;
                                setSettings({
                                  ...settings,
                                  registrationLocked: newVal,
                                });
                                setLoading(true);
                                try {
                                  await fetch(GAS_URL, {
                                    method: "POST",
                                    mode: "no-cors",
                                    body: JSON.stringify({
                                      action: "updateSettings",
                                      data: {
                                        registrationLocked: String(newVal),
                                      },
                                    }),
                                  });
                                } catch (e) {
                                  alert(e.message);
                                } finally {
                                  setLoading(false);
                                }
                              }}
                              className={`w-14 h-8 rounded-full relative transition-all cursor-pointer ${
                                settings.registrationLocked
                                  ? "bg-rose-600"
                                  : "bg-slate-700"
                              }`}
                            >
                              <div
                                className={`absolute top-1 w-6 h-6 rounded-full bg-white shadow-md transition-all ${
                                  settings.registrationLocked
                                    ? "left-7"
                                    : "left-1"
                                }`}
                              ></div>
                            </div>
                          </div>
                          <p className="text-[9px] text-slate-400 font-bold leading-relaxed">
                            æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€ç®¡ç†è€…å´ã§ã€Œãƒ¡ãƒ³ãƒãƒ¼åç°¿ã€ã«ç™»éŒ²ã•ã‚Œã¦ã„ãªã„åå‰ã¯
                            <span className="text-rose-400">
                              ã‚¢ãƒ—ãƒªã¸ã®ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆåˆ©ç”¨é–‹å§‹ï¼‰ãŒæ‹’å¦
                            </span>
                            ã•ã‚Œã¾ã™ã€‚
                          </p>
                        </div>
                      </div>

                      {/* App Constants Reference (Read Only for safety unless specifically needed) */}
                      <div className="bg-slate-100/50 p-8 rounded-[2.5rem] border border-slate-200/50 space-y-4">
                        <h4 className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2">
                          Internal Parameters (Read-only)
                        </h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div className="bg-white p-5 rounded-2xl border border-slate-100 flex justify-between items-center">
                            <span className="text-[10px] font-black text-slate-400 uppercase">
                              App Version
                            </span>
                            <span className="text-xs font-black text-slate-900 italic">
                              v8.1.0-STABLE
                            </span>
                          </div>
                          <div className="bg-white p-5 rounded-2xl border border-slate-100 flex justify-between items-center">
                            <span className="text-[10px] font-black text-slate-400 uppercase">
                              Auth Code
                            </span>
                            <span className="text-xs font-black text-[#0076FF] font-mono tracking-tighter">
                              {APP_PASS}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                ) : activeTab === "members" ? (
                  <div className="space-y-6 animate-fadeIn">
                    <div className="bg-slate-900 text-white p-10 rounded-[3.5rem] shadow-2xl relative overflow-hidden group">
                      <div className="relative z-10 flex items-center gap-8">
                        <div className="w-16 h-16 bg-white/10 rounded-2xl flex items-center justify-center text-3xl backdrop-blur-md">
                          ğŸ‘¤
                        </div>
                        <div>
                          <h3 className="text-2xl font-black italic tracking-tighter">
                            Member Master
                          </h3>
                          <p className="text-[10px] text-white/40 font-bold uppercase tracking-[0.3em] mt-1">
                            Manage authorized users
                          </p>
                        </div>
                      </div>
                      <div className="absolute top-0 right-0 p-10 opacity-10 pointer-events-none transform rotate-12 group-hover:scale-110 transition-transform">
                        <div className="text-9xl font-black italic">
                          MEMBERS
                        </div>
                      </div>
                    </div>
                    <div className="bg-white p-10 rounded-[3rem] border border-slate-200 shadow-sm space-y-8">
                      <div className="flex items-center gap-3 border-b border-slate-100 pb-6 mb-2">
                        <div className="w-2 h-6 bg-indigo-500 rounded-full"></div>
                        <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest">
                          ãƒ¡ãƒ³ãƒãƒ¼åç°¿ (ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆ)
                        </h4>
                      </div>
                      <div className="flex gap-4 bg-slate-900/5 p-6 rounded-[2.5rem] border-2 border-dashed border-slate-200 shadow-inner">
                        <input
                          id="newMember"
                          className="flex-1 bg-white p-5 rounded-3xl outline-none font-bold text-sm border-2 border-transparent focus:border-indigo-400 transition-all shadow-sm"
                          placeholder="æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼å (ä¾‹: å‰é‡)"
                        />
                        <button
                          onClick={() => {
                            const el = document.getElementById("newMember");
                            if (el.value && !members.includes(el.value)) {
                              setMembers([...members, el.value]);
                              el.value = "";
                            }
                          }}
                          className="bg-slate-900 text-white px-10 rounded-3xl font-black text-xs uppercase tracking-widest hover:bg-indigo-600 transition-all"
                        >
                          è¿½åŠ 
                        </button>
                      </div>
                      <div className="space-y-4 max-h-[400px] overflow-y-auto custom-scroll pr-2">
                        {members.length > 0 ? (
                          members.map((name, i) => (
                            <div
                              key={i}
                              className="flex justify-between items-center bg-white p-6 rounded-3xl border border-slate-100 shadow-sm border-l-4 border-l-indigo-500 group"
                            >
                              <span className="font-black text-slate-950 italic text-base">
                                {name}
                              </span>
                              <div className="flex items-center gap-4">
                                <button
                                  onClick={() => {
                                    const newName = prompt(
                                      `ã€Œ${name}ã€ã•ã‚“ã®æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`,
                                      name
                                    );
                                    if (newName && newName !== name) {
                                      handleRename(name); // Call the existing rename function
                                    }
                                  }}
                                  className="text-[10px] font-black text-indigo-300 hover:text-indigo-600 uppercase tracking-widest transition-colors"
                                >
                                  RENAME
                                </button>
                                <button
                                  onClick={() => handleDeleteMember(name)}
                                  className="text-[10px] font-black text-rose-300 hover:text-rose-600 uppercase tracking-widest transition-colors"
                                >
                                  DELETE
                                </button>
                              </div>
                            </div>
                          ))
                        ) : (
                          <div className="text-center py-10 text-slate-300 italic font-bold">
                            No members registered
                          </div>
                        )}
                      </div>
                      <button
                        onClick={saveMembers}
                        className="w-full bg-indigo-600 py-7 rounded-[2.5rem] text-white font-black shadow-2xl hover:bg-indigo-700 active:scale-[0.98] transition-all text-xs tracking-[0.3em] uppercase mt-4"
                      >
                        Commit Changes to Server
                      </button>
                      <p className="text-[9px] text-slate-500 font-bold mt-4 italic leading-relaxed">
                        â€»ã€Œã‚·ã‚¹ãƒ†ãƒ é˜²å£ã€ã‚¿ãƒ–ã§ã€Œæ–°è¦ç™»éŒ²ãƒ­ãƒƒã‚¯ã€ã‚’ONã«ã™ã‚‹ã¨ã€ã“ã“ã«ç™»éŒ²ã•ã‚ŒãŸåå‰ä»¥å¤–ã¯ãƒ­ã‚°ã‚¤ãƒ³ã§ããªããªã‚Šã¾ã™ã€‚
                      </p>
                    </div>
                  </div>
                ) : null}
              </div>
              {/* Mobile Close Button */}
              <div className="lg:hidden p-6 bg-white border-t border-slate-100 text-center shrink-0">
                <button
                  onClick={onClose}
                  className="w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-xs tracking-widest shadow-xl uppercase"
                >
                  Close Security Hub
                </button>
              </div>
            </div>
          </div>
        );
      }

      function AnalyticsModal({ onClose }) {
        const [range, setRange] = React.useState({ start: "", end: "" });
        const [data, setData] = React.useState([]);
        const [loading, setLoading] = React.useState(false);
        const [prompt, setPrompt] = React.useState(
          localStorage.getItem("kpi_prompt") ||
            `ã€ã‚¿ã‚¹ã‚¯ã€‘
ã‚¹ãƒ­ãƒƒãƒˆè»å›£ã®KPIåˆ†æãƒ»æˆ¦ç•¥ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
æä¾›ã•ã‚ŒãŸç¨¼åƒãƒ­ã‚°ã‚’ã€ŒçµŒå–¶è€…ã€ãŠã‚ˆã³ã€Œè»å›£é•·ã€ã®è¦–ç‚¹ã§æ·±ãè§£æã—ã€åç›Šã®æœ€å¤§åŒ–ã«å‘ã‘ãŸå…·ä½“çš„ãªæè¨€ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

ã€åˆ†æã®ã‚³ã‚¢åŸºæº–ã€‘
- åº—èˆ—åˆ†æã‚’ã€Œæœ€å„ªå…ˆã€ã¨ã™ã‚‹ã€‚åº—èˆ—ã”ã¨ã®æœŸå¾…å€¤æ™‚çµ¦ï¼ˆè³ªï¼‰ã¨å®Ÿåæ”¯æ™‚çµ¦ï¼ˆçµæœï¼‰ã‚’æ¯”è¼ƒã™ã‚‹ã“ã¨ã€‚
- äººç‰©åˆ†æã§ã¯ã€æœŸå¾…å€¤ã®ç©ã¿ä¸Šã’ï¼ˆä»•äº‹é‡ï¼‰ã¨å®Ÿåæ”¯ã®ä¹–é›¢ã«æ³¨ç›®ã™ã‚‹ã€‚
- æœŸå¾…å€¤ã¯ç©ã‚ã¦ã„ã‚‹ã®ã«å®Ÿåæ”¯ãŒè‘—ã—ãä½ã„å ´åˆã€ã€Œã‚„ã‚ã©ãã®ãƒŸã‚¹ï¼ˆç¶šè¡Œåˆ¤æ–­ã®ç”˜ã•ï¼‰ã€ã€Œå¼•ãä»¥å¤–ã®äººç‚ºçš„è¦å› ã€ã®å¯èƒ½æ€§ã‚’å³ã—ãæŒ‡æ‘˜ã™ã‚‹ã“ã¨ã€‚
- æ•°å€¤ã®èƒŒæ™¯ã«ã‚ã‚‹ã€Œç‰©èªï¼ˆãªãœãã†ãªã£ãŸã‹ï¼‰ã€ã‚’ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ¨æ¸¬ã™ã‚‹ã“ã¨ã€‚

ã€çµ„ç¹”ãƒ»å½¹å‰²ã€‘
- é‹å–¶ï¼ˆè¦ªï¼‰ï¼šçŸ¢è©ã€èŠåœ°
  â€»æ‰“ã¡å­ã¸å°ã‚’ãƒ‘ã‚¹ï¼ˆé«˜æœŸå¾…å€¤ã‚’è­²æ¸¡ï¼‰ã—ã€è‡ªã‚‰ã¯ã€ŒæœŸå¾…å€¤ã®ä½ã„æ®‹ã‚Šæ™‚é–“ã€ã‚„ã€Œä¿é™ºå°ã€ã‚’æ‰“ã¤ã€‚
  â€»ä½æ™‚çµ¦ã¯ã€Œæ‰“ã¡å­ã®ç¨¼åƒæ©Ÿä¼šã‚’æœ€å¤§åŒ–ã•ã›ãŸè¨¼ã€ã¨ã—ã¦ç§°è³›ã™ã¹ãæ•°å€¤ã§ã‚ã‚‹ã€‚
- å®Ÿè¡Œéƒ¨éšŠï¼ˆéƒ¨ä¸‹ï¼‰ï¼šé«˜å®®ã€äº¬å¹³ã€å‰é‡ã€ã‚Šã‚…ã†ï¼ˆç¾åœ¨ä¼‘ã¿ä¸­ï¼‰
  â€»äº¬å¹³ï¼šåœŸæ—¥å°‚é–€

ã€åº—èˆ—å±æ€§ã€‘
- ãƒ¡ã‚¤ãƒ³åº—èˆ—ï¼ˆç”Ÿå‘½ç·šï¼‰ï¼šé‡å·ã€é§’å²¡
- ç‰¹å®šåº—èˆ—ï¼šã‚°ãƒ©ã‚­ã‚³ï¼ˆçŸ¢è©æ‹…å½“ï¼‰ã€ãƒ™ãƒ«ï¼ˆèŠåœ°æ‹…å½“ï¼‰
- ã‚µãƒ–åº—èˆ—ï¼šãƒ”ãƒ¼ã‚¢ãƒ¼ã‚¯ã€ãƒ‰ãƒ©ã‚´ãƒ³
â€»é‡å·ç‰¹è¨˜ï¼šæ—¥æ›œæ—¥ã«ã€ŒãŠã™ã™ã‚æ©Ÿç¨®ã€ãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹ã€‚æ—¥æ›œã‚’èµ·ç‚¹ã¨ã—ãŸã€Œä¸€é€±é–“ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã€ã‚’åˆ†æã›ã‚ˆã€‚

ã€å¿…é ˆåˆ†æé …ç›®ã€‘
1. ãƒãƒ¼ãƒ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆæœŸå¾…å€¤ vs å®Ÿåæ”¯ï¼‰ã®ä¹–é›¢åˆ†æã€‚
2. åº—èˆ—åˆ¥QOLï¼ˆæ™‚çµ¦ï¼‰ï¼šã©ã®åº—èˆ—ãŒæœ€ã‚‚ã€Œæ¥½ã«ã€é«˜ãç©ã‚ã‚‹ã‹ã€ã‚’åˆ¤å®šã€‚
3. æ©Ÿç¨®åˆ¥åˆ†æï¼šåŒ—æ–—ã®ä¾å­˜åº¦ã¨ã€ä»–æ©Ÿç¨®ã§ã®ãƒ•ã‚©ãƒ­ãƒ¼çŠ¶æ³ã€‚
4. æ›œæ—¥ãƒ»æœŸé–“ãƒˆãƒ¬ãƒ³ãƒ‰ï¼šå¹³æ—¥ vs åœŸæ—¥ç¥ï¼ˆç¥æ—¥ã¯åœŸæ—¥ã¨åŒæ§˜ã®ç¨¼åƒå¢—ã¨ã¿ãªã™ï¼‰ã®åæ”¯æ ¼å·®ã€‚
5. äººç‰©è²¢çŒ®åº¦ & ãƒªã‚¹ã‚¯ç®¡ç†ï¼š
   - èª°ãŒæœ€ã‚‚ã€Œé«˜ã„æœŸå¾…å€¤ã‚’å¥ªå–ã—ãŸã‹ï¼ˆæœŸå¾…å€¤ï¼‰ã€ã¨ã€Œç¾å ´ã‚’æ”¯ãˆãŸã‹ï¼ˆå®Ÿåæ”¯ï¼‰ã€ã€‚
   - æœŸå¾…å€¤ã¨å®Ÿåæ”¯ãŒè‘—ã—ãä¹–é›¢ã—ã¦ã„ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ã¸ã®ã€Œã‚„ã‚ã©ãã€ã‚„ã€Œç«‹ã¡å›ã‚Šã€ã«é–¢ã™ã‚‹å…·ä½“çš„æ³¨æ„ã€‚

ã€å‡ºåŠ›å½¢å¼ã€‘
1. LINEç”¨ãƒ¬ãƒãƒ¼ãƒˆï¼ˆå³å…±æœ‰ãƒ»ã‚³ãƒ”ãƒšç”¨ï¼‰
   - è¦‹å‡ºã—ã‚’ã€ŒğŸš€ã€ã€ŒğŸ“Šã€ã€ŒğŸ“ã€ã€ŒğŸ‘¹ã€ç­‰ã®çµµæ–‡å­—ã§å¼·èª¿ã€‚
   - çµè«–ã‹ã‚‰æ›¸ãã€æ¬¡ã«è©³ç´°ã€‚
   - åˆ†æçµæœã«åŸºã¥ã„ãŸå…·ä½“çš„ãªãƒã‚¯ã‚¹ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ”»ã‚ã‚‹ã¹ãåº—èˆ—ã‚„æ³¨æ„ã™ã¹ãäººç‰©ï¼‰ã‚’æç¤ºã€‚
   - æœ€å¾Œã«ã€Œè»å›£é•·ã¸ã®æè¨€ã€ã‚’1è¡Œã§è¨˜è¼‰ã€‚

ã€å®Ÿè¡Œãƒ—ãƒ­ã‚»ã‚¹ã€‘
1. æä¾›ãƒ‡ãƒ¼ã‚¿ã®çµ±è¨ˆï¼ˆå¹³å‡ãƒ»æœ€å¤§å€¤ãƒ»ä¹–é›¢ç‡ï¼‰ã‚’ç®—å‡ºã€‚
2. èƒŒæ™¯äº‹æƒ…ï¼ˆå°ãƒ‘ã‚¹ç­‰ï¼‰ã‚’è€ƒæ…®ã—ãŸã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’è¨€èªåŒ–ã€‚
3. LINEãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã€‚

ã“ã‚Œã§åˆ†æã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚`
        );
        const [activeTab, setActiveTab] = React.useState("stats"); // stats, report, prompt, history
        const [reportResult, setReportResult] = React.useState({
          text: "",
          html: "",
        });
        const [history, setHistory] = React.useState(() => {
          try {
            return JSON.parse(
              localStorage.getItem("kpi_report_history") || "[]"
            );
          } catch (e) {
            return [];
          }
        });
        const [selectedMember, setSelectedMember] = React.useState("");
        const [selectedStore, setSelectedStore] = React.useState("");

        React.useEffect(() => {
          localStorage.setItem("kpi_report_history", JSON.stringify(history));
        }, [history]);

        React.useEffect(() => {
          const today = new Date();
          const lastMonth = new Date();
          lastMonth.setDate(today.getDate() - 30);
          const format = (d) => d.toISOString().split("T")[0];
          setRange({ start: format(lastMonth), end: format(today) });
        }, []);

        React.useEffect(() => {
          localStorage.setItem("kpi_prompt", prompt);
        }, [prompt]);

        const load = async () => {
          if (loading) return; // é‡è¤‡èª­ã¿è¾¼ã¿é˜²æ­¢
          setLoading(true);
          try {
            const res = await fetch(`${GAS_URL}?action=getAnalyticsData`);
            const json = await res.json();
            setData(json);
          } catch (e) {
            console.error("Analytics Load Error:", e);
          } finally {
            setLoading(false);
          }
        };

        // ãƒãƒã‚¦ãƒ³ãƒˆæ™‚ã«è‡ªå‹•èª­ã¿è¾¼ã¿ã‚’å®Ÿè¡Œ
        React.useEffect(() => {
          load();
        }, []);

        const calculateKPIs = (items) => {
          const kpi = {
            total: { profit: 0, ev: 0, hours: 0 },
            members: {},
            stores: {},
            machines: {},
            days: [0, 0, 0, 0, 0, 0, 0].map(() => ({ p: 0, ev: 0, h: 0 })),
            types: {
              weekday: { p: 0, ev: 0, h: 0 },
              weekend: { p: 0, ev: 0, h: 0 },
            },
          };

          // åº—èˆ—æ›é‡‘ç‡æƒ…å ±ã®å–å¾— (åº—èˆ—ãƒã‚¹ã‚¿ã‹ã‚‰)
          const storeMaster = JSON.parse(
            localStorage.getItem("kpi_store_master") || "[]"
          );

          items.forEach((item) => {
            // --- å„ªå…ˆé †ä½: 1. å‰å›æ¯”è¼ƒå®Ÿåæ”¯åˆ— (æ°¸ç¶šåŒ–ãƒ‡ãƒ¼ã‚¿), 2. è³‡ç”£æ¨ç§»è¨ˆç®—, 3. æ›é‡‘-æŠ•è³‡ ---
            const rawP = item.å‰å›æ¯”è¼ƒå®Ÿåæ”¯;
            let p =
              rawP !== undefined && rawP !== null && String(rawP).trim() !== ""
                ? parseFloat(rawP)
                : null;

            if (p === null) {
              // æ°¸ç¶šåŒ–ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®ã¿å‹•çš„ã«ç®—å‡º
              const name = item.åå‰ || item.å ±å‘Šè€… || "ä¸æ˜";
              const storeName = item.åº—èˆ—å || "";
              const storeInfo = storeMaster.find(
                (s) => s.name === storeName
              ) || { m20: 50, m5: 200, p4: 250 };
              const r20 = 1000 / (parseFloat(storeInfo.m20) || 50);
              const r5 = 1000 / (parseFloat(storeInfo.m5) || 200);
              const r4 = 1000 / (parseFloat(storeInfo.p4) || 250);

              const currentAsset =
                (parseFloat(item.æ®‹æŠ•è³‡é‡‘) || 0) +
                (parseFloat(item["20ã‚¹ãƒ­"]) || 0) * r20 +
                (parseFloat(item["5ã‚¹ãƒ­"]) || 0) * r5 +
                (parseFloat(item["4ãƒ‘ãƒ"]) || 0) * r4;

              // åŒä¸€ãƒ¡ãƒ³ãƒãƒ¼ã®å‰å›è³‡ç”£ã‚’æ¢ã™ (ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‰ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰)
              const parseDt = (v) =>
                v ? new Date(String(v).split("(")[0].trim()) : new Date(0);
              const sortedSameMember = data
                .filter((l) => (l.åå‰ || l.å ±å‘Šè€…) === name)
                .sort(
                  (a, b) =>
                    parseDt(a.æ—¥ä»˜) - parseDt(b.æ—¥ä»˜) ||
                    String(a.ID).localeCompare(String(b.ID))
                );

              const currentIdx = sortedSameMember.findIndex(
                (l) => l.ID === item.ID
              );
              const prevItem =
                currentIdx > 0 ? sortedSameMember[currentIdx - 1] : null;

              const salary =
                parseFloat(item.æœ¬æ—¥ã®çµ¦æ–™) || parseFloat(item.salary) || 0;
              const handover = parseFloat(item.æ‰‹æ¸¡ã—é¡) || 0;
              const cash = parseFloat(item.æœ¬æ—¥æŠ•è³‡) || 0;
              const received = parseFloat(item.è¦ªå—å–é¡) || 0;

              if (prevItem) {
                const prevStoreInfo =
                  storeMaster.find((s) => s.name === (prevItem.åº—èˆ—å || "")) ||
                  storeInfo;
                const pr20 = 1000 / (parseFloat(prevStoreInfo.m20) || 50);
                const pr5 = 1000 / (parseFloat(prevStoreInfo.m5) || 200);
                const pr4 = 1000 / (parseFloat(prevStoreInfo.p4) || 250);
                const prevAssetVal =
                  (parseFloat(prevItem.æ®‹æŠ•è³‡é‡‘) || 0) +
                  (parseFloat(prevItem["20ã‚¹ãƒ­"]) || 0) * pr20 +
                  (parseFloat(prevItem["5ã‚¹ãƒ­"]) || 0) * pr5 +
                  (parseFloat(prevItem["4ãƒ‘ãƒ"]) || 0) * pr4;

                // ç´”ç²‹ãªå°ã®å®Ÿåæ”¯
                p =
                  currentAsset +
                  salary +
                  handover -
                  (prevAssetVal + cash + received);
              } else {
                // åˆå›ã¯ æ›é‡‘ - æŠ•è³‡
                p = (parseFloat(item.æ›é‡‘é¡) || 0) - cash;
              }
            }

            const ev = parseFloat(item.æœŸå¾…å€¤) || 0;
            const h = parseFloat(item.ç¨¼åƒæ™‚é–“) || parseFloat(item.æ™‚é–“) || 0;
            const name = item.åå‰ || item.å ±å‘Šè€… || "ä¸æ˜";
            const dt = new Date(item.æ—¥ä»˜);
            const day = dt.getDay();
            const isWeekend = day === 0 || day === 6;

            kpi.total.profit += p;
            kpi.total.ev += ev;
            kpi.total.hours += h;

            if (!kpi.members[name]) kpi.members[name] = { p: 0, ev: 0, h: 0 };
            kpi.members[name].p += p;
            kpi.members[name].ev += ev;
            kpi.members[name].h += h;

            if (!kpi.stores[item.åº—èˆ—å])
              kpi.stores[item.åº—èˆ—å] = { p: 0, ev: 0, h: 0 };
            kpi.stores[item.åº—èˆ—å].p += p;
            kpi.stores[item.åº—èˆ—å].ev += ev;
            kpi.stores[item.åº—èˆ—å].h += h;

            // --- æ©Ÿç¨®åæ­£è¦åŒ– & è§£æãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ ---
            const normalizeMachine = (m) => {
              if (!m) return "ä¸æ˜";
              // ã€ŒåŒ—æ–—ã€ã‚’å«ã‚€ãŒã€Œè»¢ç”Ÿã€ã‚’å«ã¾ãªã„ã‚‚ã®ã ã‘ã‚’ä¸»è¦æ©Ÿç¨®ã€Œã‚¹ãƒã‚¹ãƒ­åŒ—æ–—ã®æ‹³ã€ã¨ã—ã¦çµ±åˆ
              if (m.includes("åŒ—æ–—") && !m.includes("è»¢ç”Ÿ"))
                return "ã‚¹ãƒã‚¹ãƒ­åŒ—æ–—ã®æ‹³";
              return m;
            };

            // è§£æãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯è©³ç´°ã«é›†è¨ˆ
            let meta = [];
            try {
              if (item.è§£æãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿) meta = JSON.parse(item.è§£æãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿);
            } catch (e) {}

            if (meta.length > 0) {
              meta.forEach((m) => {
                const machineName = normalizeMachine(m.machine);
                if (!kpi.machines[machineName])
                  kpi.machines[machineName] = { p: 0, ev: 0, h: 0 };
                kpi.machines[machineName].ev += parseFloat(m.ev) || 0;
              });
            } else {
              // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯è¡Œã®é ­ã‹ã‚‰æ¨æ¸¬
              const machine = normalizeMachine(
                item.æ©Ÿç¨® ||
                  (item.ç¨¼å‹•å†…å®¹
                    ? String(item.ç¨¼å‹•å†…å®¹).split(/[ \n]/)[0]
                    : "ä¸æ˜")
              );
              if (!kpi.machines[machine])
                kpi.machines[machine] = { p: 0, ev: 0, h: 0 };
              kpi.machines[machine].ev += ev;
            }

            kpi.days[day].p += p;
            kpi.days[day].ev += ev;
            kpi.days[day].h += h;
            const type = isWeekend ? "weekend" : "weekday";
            kpi.types[type].p += p;
            kpi.types[type].ev += ev;
            kpi.types[type].h += h;
          });
          return kpi;
        };

        const generateReport = async () => {
          setLoading(true);
          try {
            const kpi = calculateKPIs(filtered);

            // æœŸé–“æ¯”è¼ƒç”¨ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
            const sDate = new Date(range.start);
            const eDate = new Date(range.end);
            const diffDays =
              Math.ceil((eDate - sDate) / (1000 * 60 * 60 * 24)) + 1;
            const prevStart = new Date(sDate);
            prevStart.setDate(sDate.getDate() - diffDays);
            const prevEnd = new Date(sDate);
            prevEnd.setDate(sDate.getDate() - 1);
            const prevFiltered = data.filter((d) => {
              const dt = new Date(d.æ—¥ä»˜);
              return dt >= prevStart && dt <= prevEnd;
            });
            const prevKpi = calculateKPIs(prevFiltered);

            // AIã«é€ä¿¡ã™ã‚‹çµ±è¨ˆæƒ…å ±ã®è¦ç´„
            const statsSummary = {
              period: { start: range.start, end: range.end, days: diffDays },
              total: kpi.total,
              comparison_prev_period: {
                profit_diff: kpi.total.profit - prevKpi.total.profit,
                ev_diff: kpi.total.ev - prevKpi.total.ev,
              },
              members: kpi.members,
              stores: kpi.stores,
              machines: kpi.machines,
              day_of_week: kpi.days
                .map((s, i) => ({
                  day: ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"][i],
                  rate: Math.round(s.p / (s.h || 1)),
                }))
                .filter((s) => s.rate !== 0),
              type_stats: kpi.types,
            };

            // GASã®AIè§£æAPIã‚’å‘¼ã³å‡ºã—
            const res = await fetch(GAS_URL, {
              method: "POST",
              body: JSON.stringify({
                action: "runKPIAnalysis",
                data: {
                  prompt: prompt,
                  stats: statsSummary,
                },
              }),
            });

            const json = await res.json();
            if (json.status !== "success") {
              const errorMsg =
                json.message || json.result || "AIè§£æã«å¤±æ•—ã—ã¾ã—ãŸ";
              throw new Error(errorMsg);
            }

            const aiText = json.result;
            const result = { text: aiText, html: "" };
            setReportResult(result);

            // å±¥æ­´ã«ä¿å­˜
            const newHistoryItem = {
              id: Date.now(),
              date: new Date().toLocaleString("ja-JP"),
              range: `${range.start}ã€œ${range.end}`,
              text: aiText,
              summary: {
                profit: kpi.total.profit,
                ev: kpi.total.ev,
              },
            };
            setHistory((prev) => [newHistoryItem, ...prev].slice(0, 50));
            setActiveTab("report");
          } catch (e) {
            console.error("AI Analysis Error:", e);
            alert(
              "âš ï¸ AIè§£æã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n" +
                e.message +
                "\n\n(ã‚¯ã‚©ãƒ¼ã‚¿åˆ¶é™ã€ã¾ãŸã¯ãƒ¢ãƒ‡ãƒ«ã®ä¸€æ¬¡çš„ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™)"
            );
          } finally {
            setLoading(false);
          }
        };
        const memberList = React.useMemo(() => {
          const members = new Set();
          const targetData = selectedStore
            ? data.filter((d) => d.åº—èˆ—å === selectedStore)
            : data;
          targetData.forEach((d) => {
            const name = d.åå‰ || d.å ±å‘Šè€…;
            if (name) members.add(name);
          });
          return Array.from(members).sort();
        }, [data, selectedStore]);

        const storeList = React.useMemo(() => {
          const stores = new Set();
          const targetData = selectedMember
            ? data.filter((d) => (d.åå‰ || d.å ±å‘Šè€…) === selectedMember)
            : data;
          targetData.forEach((d) => {
            if (d.åº—èˆ—å) stores.add(d.åº—èˆ—å);
          });
          return Array.from(stores).sort();
        }, [data, selectedMember]);

        const filtered = React.useMemo(() => {
          if (!range.start || !range.end) return [];
          const s = new Date(range.start);
          const e = new Date(range.end);
          return data.filter((d) => {
            const dt = new Date(d.æ—¥ä»˜);
            const inRange = dt >= s && dt <= e;
            const matchMember =
              !selectedMember || (d.åå‰ || d.å ±å‘Šè€…) === selectedMember;
            const matchStore = !selectedStore || d.åº—èˆ—å === selectedStore;
            return inRange && matchMember && matchStore;
          });
        }, [data, range, selectedMember, selectedStore]);
        const stats = React.useMemo(() => {
          // calculateKPIs ã‚’åˆ©ç”¨ã—ã¦ stats ã‚’ç”Ÿæˆ (ãƒ­ãƒƒã‚¯åŒæœŸã•ã›ã‚‹ãŸã‚)
          const kpi = calculateKPIs(filtered);
          return {
            totalProfit: kpi.total.profit,
            totalEv: kpi.total.ev,
            totalHours: kpi.total.hours,
            person: kpi.members,
            store: kpi.stores,
          };
        }, [filtered, data]); // dataã‚‚ç›£è¦–å¯¾è±¡ã«ã™ã‚‹ (enrichedè¨ˆç®—ã®ãŸã‚)
        const copyReport = () => {
          const text = `ã€KPIåˆ†æãƒ¬ãƒãƒ¼ãƒˆã€‘\næœŸé–“: ${range.start} ã€œ ${
            range.end
          }\n\nâ– å…¨ä½“åˆè¨ˆ\nå®Ÿåæ”¯: ${stats.totalProfit.toLocaleString()}å††\næœŸå¾…å€¤: ${stats.totalEv.toLocaleString()}å††\nç¨¼å‹•æ™‚é–“: ${
            stats.totalHours
          }h\næ™‚çµ¦: ${Math.round(
            stats.totalProfit / (stats.totalHours || 1)
          )}å††\n\nâ– å€‹äººåˆ¥å®Ÿåæ”¯\n${Object.entries(stats.person)
            .map(
              ([name, s]) =>
                `${name}: ${s.p.toLocaleString()}å†† (${s.h}h/æ™‚çµ¦${Math.round(
                  s.p / (s.h || 1)
                )}å††)`
            )
            .join("\n")}`;
          navigator.clipboard.writeText(text);
          alert("LINEç”¨ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        };
        return (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-0 md:p-4 bg-slate-900/90 backdrop-blur-sm animate-fadeIn">
            <div className="bg-white md:rounded-[3rem] w-full max-w-5xl h-full md:h-[85vh] flex flex-col shadow-2xl overflow-hidden text-slate-900">
              <div className="px-4 py-3 md:p-8 border-b border-slate-100 flex justify-between items-center bg-slate-50 shrink-0">
                <div className="flex items-center gap-2">
                  <div className="w-8 h-8 md:w-10 md:h-10 bg-emerald-600 rounded-xl flex items-center justify-center text-sm md:text-xl shadow-lg shrink-0">
                    ğŸ“Š
                  </div>
                  <h2 className="text-sm md:text-2xl font-black italic uppercase tracking-tighter">
                    KPIåˆ†æ
                  </h2>
                </div>
                <button
                  onClick={onClose}
                  className="w-8 h-8 flex items-center justify-center text-slate-300 hover:text-rose-500 text-2xl transition-colors font-black"
                >
                  âœ•
                </button>
              </div>
              <div className="p-3 md:p-8 bg-slate-50 border-b border-slate-100 flex flex-col gap-3 md:gap-4 shrink-0">
                <div className="grid grid-cols-2 md:flex md:flex-wrap gap-2 md:gap-4 items-end">
                  <div className="space-y-1">
                    <label className="text-[8px] md:text-[10px] font-black text-slate-400 uppercase ml-1 md:ml-2">
                      é–‹å§‹æ—¥
                    </label>
                    <input
                      type="date"
                      value={range.start}
                      onChange={(e) =>
                        setRange({ ...range, start: e.target.value })
                      }
                      className="w-full bg-white px-2 md:px-4 py-1.5 md:py-2 rounded-lg md:rounded-xl text-[10px] md:text-sm font-bold border border-slate-200 outline-none"
                    />
                  </div>
                  <div className="space-y-1">
                    <label className="text-[8px] md:text-[10px] font-black text-slate-400 uppercase ml-1 md:ml-2">
                      çµ‚äº†æ—¥
                    </label>
                    <input
                      type="date"
                      value={range.end}
                      onChange={(e) =>
                        setRange({ ...range, end: e.target.value })
                      }
                      className="w-full bg-white px-2 md:px-4 py-1.5 md:py-2 rounded-lg md:rounded-xl text-[10px] md:text-sm font-bold border border-slate-200 outline-none"
                    />
                  </div>
                  <div className="space-y-1">
                    <label className="text-[8px] md:text-[10px] font-black text-slate-400 uppercase ml-1 md:ml-2">
                      äººç‰©
                    </label>
                    <select
                      value={selectedMember}
                      onChange={(e) => setSelectedMember(e.target.value)}
                      className="w-full bg-white px-2 md:px-4 py-1.5 md:py-2 rounded-lg md:rounded-xl text-[10px] md:text-sm font-bold border border-slate-200 outline-none cursor-pointer hover:border-[#0076FF] transition-colors"
                    >
                      <option value="">å…¨å“¡</option>
                      {memberList.map((m) => (
                        <option key={m} value={m}>
                          {m}
                        </option>
                      ))}
                    </select>
                  </div>
                  <div className="space-y-1">
                    <label className="text-[8px] md:text-[10px] font-black text-slate-400 uppercase ml-1 md:ml-2 flex items-center justify-between">
                      <span>åº—èˆ—</span>
                      {(selectedMember || selectedStore) && (
                        <button
                          onClick={() => {
                            setSelectedMember("");
                            setSelectedStore("");
                          }} // ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½
                          className="text-[7px] md:text-[8px] text-rose-500 font-bold border-b border-rose-500 leading-none"
                        >
                          âœ•
                        </button>
                      )}
                    </label>
                    <select
                      value={selectedStore}
                      onChange={(e) => setSelectedStore(e.target.value)}
                      className="w-full bg-white px-2 md:px-4 py-1.5 md:py-2 rounded-lg md:rounded-xl text-[10px] md:text-sm font-bold border border-slate-200 outline-none cursor-pointer hover:border-[#0076FF] transition-colors"
                    >
                      <option value="">å…¨åº—</option>
                      {storeList.map((s) => (
                        <option key={s} value={s}>
                          {s}
                        </option>
                      ))}
                    </select>
                  </div>
                </div>
                <button
                  onClick={load}
                  disabled={loading}
                  className="w-full md:w-auto bg-[#0076FF] text-white px-8 py-2 md:py-2.5 rounded-lg md:rounded-xl font-black text-[10px] uppercase tracking-widest shadow-lg disabled:opacity-50"
                >
                  {loading ? "âŒ› è§£æä¸­..." : "ãƒ‡ãƒ¼ã‚¿ã‚’å®Ÿè¡Œè§£æ"}
                </button>
              </div>

              <div className="flex bg-slate-100 p-1 shrink-0">
                {["stats", "report", "history", "prompt"].map((t) => (
                  <button
                    key={t}
                    onClick={() => setActiveTab(t)}
                    className={`flex-1 py-4 text-[10px] font-black uppercase tracking-widest transition-all ${
                      activeTab === t
                        ? "bg-white shadow-sm text-[#0076FF]"
                        : "text-slate-400"
                    }`}
                  >
                    {t === "stats"
                      ? "ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ ğŸ“Š"
                      : t === "report"
                      ? "ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ› ğŸ“"
                      : t === "history"
                      ? "åˆ†æå±¥æ­´ âŒ›"
                      : "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š âš™ï¸"}
                  </button>
                ))}
              </div>

              <div className="flex-1 overflow-y-auto custom-scroll">
                {activeTab === "stats" && (
                  <div className="p-4 md:p-10 space-y-6 md:space-y-10">
                    <div className="grid grid-cols-1 gap-4 md:gap-6">
                      <div className="bg-slate-900 p-6 md:p-8 rounded-3xl md:rounded-[2.5rem] text-white shadow-xl relative overflow-hidden">
                        <div className="text-[8px] md:text-[10px] font-black opacity-40 uppercase tracking-widest">
                          ç·å®Ÿåæ”¯
                        </div>
                        <div className="text-2xl md:text-4xl font-black italic relative z-10">
                          {stats.totalProfit.toLocaleString()}
                          <span className="text-xs md:text-sm ml-2">å††</span>
                        </div>
                        <div className="absolute top-0 right-0 p-4 opacity-5 text-4xl">
                          ğŸ’°
                        </div>
                      </div>
                      <div className="grid grid-cols-2 gap-4">
                        <div className="bg-white border border-slate-100 p-6 md:p-8 rounded-3xl md:rounded-[2.5rem] shadow-sm">
                          <div className="text-[8px] md:text-[10px] font-black text-slate-400 uppercase tracking-widest">
                            ç·æœŸå¾…å€¤
                          </div>
                          <div className="text-xl md:text-4xl font-black italic text-[#0076FF]">
                            {stats.totalEv.toLocaleString()}
                            <span className="text-xs md:text-sm ml-1 md:ml-2">
                              å††
                            </span>
                          </div>
                        </div>
                        <div className="bg-white border border-slate-100 p-6 md:p-8 rounded-3xl md:rounded-[2.5rem] shadow-sm">
                          <div className="text-[8px] md:text-[10px] font-black text-slate-400 uppercase tracking-widest">
                            å¹³å‡æ™‚çµ¦
                          </div>
                          <div className="text-xl md:text-4xl font-black italic text-emerald-600">
                            {Math.round(
                              stats.totalProfit / (stats.totalHours || 1)
                            ).toLocaleString()}
                            <span className="text-xs md:text-sm ml-1 md:ml-2">
                              å††
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-10">
                      <div className="space-y-4">
                        <h3 className="text-xs font-black uppercase tracking-widest px-2">
                          ãƒ¡ãƒ³ãƒãƒ¼åˆ¥æœŸå¾…å€¤ãƒ©ãƒ³ã‚­ãƒ³ã‚°
                        </h3>
                        <div className="bg-slate-50 border border-slate-100 rounded-[2.5rem] overflow-hidden">
                          <table className="w-full text-xs">
                            <thead className="bg-slate-100 text-[10px] font-black text-slate-400 uppercase">
                              <tr>
                                <th className="p-4 text-left">åå‰</th>
                                <th className="p-4 text-right">æœŸå¾…å€¤</th>
                                <th className="p-4 text-right">å®Ÿåæ”¯</th>
                              </tr>
                            </thead>
                            <tbody className="font-bold">
                              {Object.entries(stats.person)
                                .sort((a, b) => b[1].ev - a[1].ev)
                                .map(([n, s]) => (
                                  <tr
                                    key={n}
                                    className="border-t border-slate-200"
                                  >
                                    <td className="p-4">{n}</td>
                                    <td className="p-4 text-right text-[#0076FF]">
                                      {s.ev.toLocaleString()}
                                    </td>
                                    <td className="p-4 text-right">
                                      {s.p.toLocaleString()}
                                    </td>
                                  </tr>
                                ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                      <div className="space-y-4">
                        <h3 className="text-xs font-black uppercase tracking-widest px-2">
                          åº—èˆ—åˆ¥å®Ÿåæ”¯ãƒ©ãƒ³ã‚­ãƒ³ã‚°
                        </h3>
                        <div className="bg-slate-50 border border-slate-100 rounded-[2.5rem] overflow-hidden">
                          <table className="w-full text-xs">
                            <thead className="bg-slate-100 text-[10px] font-black text-slate-400 uppercase">
                              <tr>
                                <th className="p-4 text-left">åº—èˆ—</th>
                                <th className="p-4 text-right">æ™‚çµ¦</th>
                                <th className="p-4 text-right">ç·ç›Š</th>
                              </tr>
                            </thead>
                            <tbody className="font-bold">
                              {Object.entries(stats.store)
                                .sort(
                                  (a, b) =>
                                    b[1].p / (b[1].h || 1) -
                                    a[1].p / (a[1].h || 1)
                                )
                                .map(([n, s]) => (
                                  <tr
                                    key={n}
                                    className="border-t border-slate-200"
                                  >
                                    <td className="p-4">{n}</td>
                                    <td className="p-4 text-right text-emerald-600">
                                      {Math.round(
                                        s.p / (s.h || 1)
                                      ).toLocaleString()}
                                      /h
                                    </td>
                                    <td className="p-4 text-right opacity-40">
                                      {s.p.toLocaleString()}
                                    </td>
                                  </tr>
                                ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                    <div className="flex justify-center pt-10">
                      <button
                        onClick={generateReport}
                        className="bg-slate-900 text-white px-12 py-5 rounded-[2rem] font-black shadow-2xl hover:scale-105 transition-all text-xs tracking-widest"
                      >
                        ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
                      </button>
                    </div>
                  </div>
                )}

                {activeTab === "report" && (
                  <div className="p-10 space-y-10 max-w-2xl mx-auto">
                    <div className="bg-white border-2 border-slate-100 p-10 rounded-[3rem] shadow-xl space-y-8">
                      <div className="flex justify-between items-center">
                        <h3 className="text-xl font-black italic">
                          LINE Report Output
                        </h3>
                        <div className="flex gap-4">
                          <button
                            onClick={() => {
                              navigator.clipboard.writeText(reportResult.text);
                              alert("LINEãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
                            }}
                            className="text-[#0076FF] font-black text-[10px] uppercase border-b-2 border-[#0076FF]"
                          >
                            Copy Line Report
                          </button>
                          <button
                            onClick={() => {
                              const payload = {
                                prompt,
                                range,
                                summary: stats,
                                raw_data: filtered,
                              };
                              navigator.clipboard.writeText(
                                JSON.stringify(payload, null, 2)
                              );
                              alert("AIè§£æç”¨ãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
                            }}
                            className="text-emerald-600 font-black text-[10px] uppercase border-b-2 border-emerald-600"
                          >
                            Copy Data for AI (JSON)
                          </button>
                        </div>
                      </div>
                      <pre className="whitespace-pre-wrap font-bold text-sm bg-slate-50 p-8 rounded-3xl border border-slate-100 leading-relaxed text-slate-700">
                        {reportResult.text ||
                          "å…ˆã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„"}
                      </pre>
                    </div>

                    <div className="bg-gradient-to-br from-indigo-900 via-slate-900 to-black p-10 rounded-[3rem] shadow-2xl text-white space-y-8 overflow-hidden relative">
                      <div className="flex justify-between items-center relative z-10">
                        <h3 className="text-xl font-black italic uppercase tracking-widest">
                          Visual Insight
                        </h3>
                        <span className="text-[10px] font-black opacity-40">
                          Mobile Optimized View
                        </span>
                      </div>
                      <div className="space-y-6 relative z-10">
                        <div className="grid grid-cols-2 gap-4 text-center">
                          <div className="bg-white/10 p-6 rounded-3xl border border-white/5">
                            <div className="text-[9px] font-black opacity-50 uppercase mb-2">
                              ç·æœŸå¾…å€¤
                            </div>
                            <div className="text-2xl font-black text-[#00E0FF]">
                              {stats.totalEv.toLocaleString()}
                            </div>
                          </div>
                          <div className="bg-white/10 p-6 rounded-3xl border border-white/5">
                            <div className="text-[9px] font-black opacity-50 uppercase mb-2">
                              ç·å®Ÿåæ”¯
                            </div>
                            <div className="text-2xl font-black text-[#00FF85]">
                              {stats.totalProfit.toLocaleString()}
                            </div>
                          </div>
                        </div>
                        <div className="bg-white/5 p-8 rounded-[2rem] border border-white/5 backdrop-blur-md">
                          <div className="text-xs font-black mb-4 flex items-center justify-between">
                            <span>åº—èˆ—åˆ¥æ™‚çµ¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>
                            <span className="text-[10px] opacity-40 italic">
                              å®Ÿåæ”¯ROIé †
                            </span>
                          </div>
                          <div className="space-y-3">
                            {Object.entries(stats.store)
                              .sort(
                                (a, b) =>
                                  b[1].p / (b[1].h || 1) -
                                  a[1].p / (a[1].h || 1)
                              )
                              .slice(0, 3)
                              .map(([n, s], i) => (
                                <div
                                  key={n}
                                  className="flex justify-between items-center text-sm"
                                >
                                  <div className="flex items-center gap-3">
                                    <span className="text-[10px] w-5 h-5 flex items-center justify-center bg-white/20 rounded-full">
                                      {i + 1}
                                    </span>
                                    <span className="font-bold">{n}</span>
                                  </div>
                                  <span className="font-black text-[#00FF85]">
                                    {Math.round(
                                      s.p / (s.h || 1)
                                    ).toLocaleString()}{" "}
                                    å††/h
                                  </span>
                                </div>
                              ))}
                          </div>
                        </div>
                      </div>
                      <div className="absolute top-0 right-0 p-10 opacity-5 pointer-events-none transform rotate-12">
                        <div className="text-9xl font-black italic">KPI</div>
                      </div>
                    </div>
                    <p className="text-center text-[10px] font-black text-slate-400 uppercase italic">
                      â€»ã“ã®ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚¨ãƒªã‚¢ã‚’ã‚¹ã‚¯ã‚·ãƒ§ã—ã¦å…±æœ‰ã—ã¦ãã ã•ã„
                    </p>
                  </div>
                )}

                {activeTab === "history" && (
                  <div className="p-10 space-y-6">
                    <div className="flex justify-between items-center">
                      <h3 className="text-xl font-black italic uppercase">
                        Report History
                      </h3>
                      {history.length > 0 && (
                        <button
                          onClick={() => {
                            if (confirm("å…¨ã¦ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"))
                              setHistory([]);
                          }}
                          className="text-rose-500 font-black text-[10px] uppercase border-b-2 border-rose-500"
                        >
                          Clear All History
                        </button>
                      )}
                    </div>
                    {history.length === 0 ? (
                      <div className="text-center py-20 text-slate-300 font-black italic">
                        No history found.
                      </div>
                    ) : (
                      <div className="grid grid-cols-1 gap-4">
                        {history.map((h) => (
                          <div
                            key={h.id}
                            className="bg-white border border-slate-100 p-6 rounded-[2rem] shadow-sm hover:shadow-md transition-all flex justify-between items-center group"
                          >
                            <div className="space-y-1">
                              <div className="text-[10px] font-black text-[#0076FF]">
                                {h.date}
                              </div>
                              <div className="text-sm font-black text-slate-700">
                                {h.range}
                              </div>
                              <div className="text-[10px] font-bold text-slate-400">
                                Profit: {h.summary.profit.toLocaleString()}å†† /
                                EV: {h.summary.ev.toLocaleString()}å††
                              </div>
                            </div>
                            <div className="flex gap-3">
                              <button
                                onClick={() => {
                                  setReportResult({ text: h.text, html: "" });
                                  setActiveTab("report");
                                }}
                                className="bg-slate-900 text-white px-5 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest"
                              >
                                View
                              </button>
                              <button
                                onClick={() => {
                                  if (confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                                    setHistory((prev) =>
                                      prev.filter((i) => i.id !== h.id)
                                    );
                                  }
                                }}
                                className="bg-slate-100 text-slate-400 hover:text-rose-500 px-5 py-2 rounded-xl text-[9px] font-black uppercase transition-colors"
                              >
                                Delete
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                )}

                {activeTab === "prompt" && (
                  <div className="p-10 space-y-6 flex flex-col h-full">
                    <div className="flex-1 space-y-4">
                      <label className="text-xs font-black uppercase tracking-[0.2em] text-slate-400 ml-2">
                        Analysis Instruction (Prompt)
                      </label>
                      <textarea
                        value={prompt}
                        onChange={(e) => setPrompt(e.target.value)}
                        className="w-full h-[300px] lg:h-[450px] bg-slate-50 border border-slate-200 rounded-[2.5rem] p-10 text-xs font-bold leading-relaxed focus:border-[#0076FF] outline-none shadow-inner"
                        placeholder="åˆ†æã®æŒ‡ç¤ºï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã‚’ã“ã“ã«è¨˜è¿°ã—ã¦ãã ã•ã„"
                      />
                    </div>
                    <div className="p-4 bg-amber-50 rounded-2xl border border-amber-100 flex gap-4 text-amber-700">
                      <span className="text-xl">ğŸ’¡</span>
                      <p className="text-[10px] font-bold leading-relaxed">
                        ã“ã“ã§ã®ä¿®æ­£ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã€æ¬¡å›ã®ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«åæ˜ ã•ã‚Œã¾ã™ã€‚
                        <br />
                        ç‰¹å®šã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ ã—ãŸã‚Šã€åˆ†æã®å„ªå…ˆé †ä½ã‚’èª¿æ•´ã™ã‚‹éš›ã«ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
                      </p>
                    </div>
                  </div>
                )}
              </div>
              <div className="p-8 border-t border-slate-100 bg-slate-50 shrink-0">
                <button
                  onClick={() => {
                    if (!reportResult.text) {
                      generateReport();
                    }
                    navigator.clipboard.writeText(reportResult.text);
                    alert("æœ€æ–°ã®é«˜åº¦åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
                  }}
                  className="w-full bg-slate-900 py-5 rounded-3xl text-white font-black shadow-xl uppercase tracking-widest text-xs"
                >
                  Copy for LINE Report
                </button>
              </div>
            </div>
          </div>
        );
      }

      function AdminApp() {
        const [isLocked, setIsLocked] = useState(true);
        const [passInput, setPassInput] = useState("");
        const [reports, setReports] = useState([]);
        const [selectedId, setSelectedId] = useState(null);
        const [evMode, setEvMode] = useState("è¨­å®šï¼‘ç›¸å½“");
        const [logs, setLogs] = useState([]);
        const [dictionary, setDictionary] = useState([]);
        const [loading, setLoading] = useState(false);
        const [isSidebarOpen, setIsSidebarOpen] = useState(false);
        const [showMaster, setShowMaster] = useState(false);
        const [showSecurity, setShowSecurity] = useState(false);
        const [showAnalytics, setShowAnalytics] = useState(false);
        const [showDebug, setShowDebug] = useState(false);
        const [strategyData, setStrategyData] = useState([]);
        const [archive, setArchive] = useState([]);
        const [showLibrary, setShowLibrary] = useState(false);

        const [aiNormalization, setAiNormalization] = useState(null);
        const [isAiAnalyzing, setIsAiAnalyzing] = useState(false);
        const [syncInfo, setSyncInfo] = useState("");
        const [checkedIds, setCheckedIds] = useState([]);
        const [editData, setEditData] = useState(null);

        const formatDateLocal = (dateStr) => {
          if (!dateStr) return "";
          // ã™ã§ã« yyyy-MM-dd ã‹ yyyy/MM/dd ã®å½¢å¼ãªã‚‰ã€æ¨™æº–åŒ–ã—ã¦è¿”ã™ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¤‰æ›ã‚’é¿ã‘ã‚‹ï¼‰
          const match = String(dateStr).match(
            /^(\d{4})[/-](\d{1,2})[/-](\d{1,2})/
          );
          if (match) {
            const y = match[1];
            const m = match[2].padStart(2, "0");
            const day = match[3].padStart(2, "0");
            return `${y}-${m}-${day}`;
          }

          const d = new Date(dateStr);
          if (isNaN(d.getTime())) return dateStr;
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, "0");
          const day = String(d.getDate()).padStart(2, "0");
          return `${y}-${m}-${day}`;
        };

        useEffect(() => {
          const passVerified = localStorage.getItem("ap_v7") === APP_PASS;
          if (passVerified) {
            setIsLocked(false);
            loadAll();
          }
        }, []);

        const loadAll = async () => {
          setLoading(true);
          setSyncInfo("ğŸ“¡ åŒæœŸã‚’é–‹å§‹ä¸­...");

          /**
           * æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ä»˜ãã®ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½
           */
          const fetchWithRetry = async (
            url,
            options = {},
            retries = 3,
            backoff = 1000
          ) => {
            try {
              const res = await fetch(url, options);
              if (!res.ok) throw new Error(`HTTP ${res.status}`);
              return await res.json();
            } catch (err) {
              if (retries > 0) {
                const attempt = 4 - retries;
                setSyncInfo(`âš ï¸ æ¥ç¶šå¾…æ©Ÿä¸­... å†è©¦è¡Œ ${attempt}/3`);
                console.warn(`Fetch error, retrying... (${attempt}/3):`, err);
                await new Promise((r) => setTimeout(r, backoff));
                return fetchWithRetry(url, options, retries - 1, backoff * 2);
              }
              throw err;
            }
          };

          try {
            setSyncInfo("ğŸ“¦ ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬å–å¾—ä¸­...");
            const result = await fetchWithRetry(
              `${GAS_URL}?action=getAdminInitialData`
            );

            if (!result || typeof result !== "object") {
              throw new Error("ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚’å—ä¿¡ã—ã¾ã—ãŸ");
            }

            const { pending, hokuto, strategy, archive, resetMaster } = result;

            // å ±å‘Šãƒ‡ãƒ¼ã‚¿ã‚’IDï¼ˆUUIDï¼‰ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹
            const grouped = (pending || []).reduce((acc, r) => {
              const id = r.ID || Utilities.getUuid(); // ä¸‡ãŒä¸€IDãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆé€šå¸¸ã¯ã‚ã‚‹ã¯ãšï¼‰
              if (!acc[id]) {
                acc[id] = {
                  id: id,
                  name: r.åå‰ || r.å ±å‘Šè€… || "ä¸æ˜",
                  date: r.æ—¥ä»˜,
                  status: r.Status || "Pending",
                  stores: []
                };
              }
              acc[id].stores.push(r);
              return acc;
            }, {});

            setReports(Object.values(grouped));
            
            setDictionary(hokuto?.dictionary || []);
            window.LATEST_DICT = hokuto?.dictionary || [];
            setStrategyData(strategy || []);
            setArchive(archive || []);
            setResetMaster(resetMaster || []);
            window.HOKUTO_MASTER = hokuto?.data || {
              è¨­å®šï¼‘ç›¸å½“: {},
              å„ªè‰¯åº—: {},
            };

            // è–åŸŸãƒ­ã‚¸ãƒƒã‚¯ï¼ˆåŒ—æ–—ï¼‰ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
            const masterCount = Object.keys(
              hokuto?.data?.["è¨­å®šï¼‘ç›¸å½“"] || {}
            ).length;
            setSyncInfo(
              `âœ… åŒæœŸå®Œäº†: å ±å‘Š${
                (pending || []).length
              }ä»¶ / ãƒã‚¹ã‚¿${masterCount}æš`
            );
          } catch (e) {
            setSyncInfo("âŒ åŒæœŸå¤±æ•—: " + e.message);
            console.error("Sync Critical Error:", e);
            // è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚ˆã—ãã•ã‚“ã«é€šçŸ¥ã™ã‚‹ãŸã‚ã®ã‚¢ãƒ©ãƒ¼ãƒˆ
            alert(
              "åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚\nã‚¨ãƒ©ãƒ¼: " +
                e.message
            );
          } finally {
            setLoading(false);
          }
        };

        const getField = (obj, keys) => {
          if (!obj) return "";
          const allKeys = Object.keys(obj);
          for (let k of keys) {
            const foundKey = allKeys.find(
              (ak) => ak.trim() === String(k).trim()
            );
            if (foundKey) {
              const val = obj[foundKey];
              // null/undefined ã§ãªã‘ã‚Œã°ã€ç©ºæ–‡å­—ã§ã‚ã£ã¦ã‚‚æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦è¿”ã™
              if (
                val !== undefined &&
                val !== null &&
                String(val) !== "undefined"
              ) {
                return String(val);
              }
            }
          }
          return "";
        };

        // æœä¸€ãƒªã‚»ãƒƒãƒˆæœŸå¾…å€¤ãƒã‚¹ã‚¿ (Stateç®¡ç†ã¸ç§»è¡Œ)
        const [resetMaster, setResetMaster] = React.useState([]);

        // é‡‘èã‚¿ã‚°æŠ½å‡ºãƒ»é™¤å»ç”¨ã®å…±é€šæ­£è¦è¡¨ç¾
        const FINANCE_TAG_RE =
          /\[(?:20ã‚¹ãƒ­|5ã‚¹ãƒ­|4ãƒ‘ãƒ|æœ¬æ—¥æŠ•è³‡|æŠ•è³‡|æŠ•è³‡é¡|cash|æœ¬æ—¥çµ¦æ–™|çµ¦æ–™|æ®‹æŠ•è³‡é‡‘|æ®‹é«˜)[:ï¼š][^\]]*\]/gi;

        const parseFinance = (report) => {
          const rawMemo = getField(report, ["å‚™è€ƒ", "memo", "å‚™è€ƒæ¬„", ""]);
          const memo = String(rawMemo || ""); // æ˜ç¤ºçš„ã«æ–‡å­—åˆ—å¤‰æ›ã—ã¦ã‚¯ãƒ©ãƒƒã‚·ãƒ¥é˜²æ­¢
          const result = {
            text: memo || "",
            medal20: 0,
            medal5: 0,
            pachi4: 0,
            cash: 0,
            salary: 0,
            remaining: 0,
          };
          if (!memo) return result;

          // ã‚¿ã‚°å½¢å¼ [...] ã‹ã‚‰ã®æŠ½å‡ºã‚’å¼·åŒ– (å…¨è§’åŠè§’ã€ãƒ­ã®æœ‰ç„¡ã«å¯¾å¿œ)
          const m20 = memo.match(
            /\[(?:20ã‚¹ãƒ­?|ãƒ¡ãƒ€ãƒ«|æš|20slot)[:ï¼š]\s*([+-]?\d+)/i
          );
          const m5 = memo.match(/\[(?:5ã‚¹ãƒ­?|5slot)[:ï¼š]\s*([+-]?\d+)/i);
          const p4 = memo.match(/\[(?:4ãƒ‘ãƒ?|4å††|4pachi)[:ï¼š]\s*([+-]?\d+)/i);
          const cMatch = memo.match(
            /\[(?:æœ¬æ—¥æŠ•è³‡|æŠ•è³‡|æŠ•è³‡é¡|cash)[:ï¼š]\s*([+-]?\d+)/i
          );
          const sMatch = memo.match(/\[(?:æœ¬æ—¥çµ¦æ–™|çµ¦æ–™)[:ï¼š]\s*([+-]?\d+)/i);
          const rMatch = memo.match(/\[(?:æ®‹æŠ•è³‡é‡‘|æ®‹é«˜)[:ï¼š]\s*([+-]?\d+)/i);

          if (m20) result.medal20 = parseInt(m20[1]) || 0;
          if (m5) result.medal5 = parseInt(m5[1]) || 0;
          if (p4) result.pachi4 = parseInt(p4[1]) || 0;
          if (cMatch) result.cash = parseInt(cMatch[1]) || 0;
          if (sMatch) result.salary = parseInt(sMatch[1]) || 0;
          if (rMatch) result.remaining = parseInt(rMatch[1]) || 0;

          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚¿ã‚°å½¢å¼ä»¥å¤–ï¼ˆæ—§å½¢å¼ã‚„æ‰‹å…¥åŠ›ï¼‰
          if (!m20) {
            const fallbackM20 = memo.match(
              /(?:20ã‚¹ãƒ­?|ãƒ¡ãƒ€ãƒ«|æš)[:ï¼š]?\s*([+-]?\d+)/i
            );
            if (fallbackM20) result.medal20 = parseInt(fallbackM20[1]) || 0;
          }
          if (!cMatch) {
            const fallbackC = memo.match(
              /(?:æœ¬æ—¥æŠ•è³‡|æŠ•è³‡|ç¾é‡‘|æŠ•è³‡é¡|å††)[:ï¼š]?\s*([+-]?\d+)/i
            );
            if (fallbackC) result.cash = parseInt(fallbackC[1]) || 0;
          }

          // ç‰¹å®šã®é‡‘èã‚¿ã‚°ã®ã¿ã‚’æ­£ç¢ºã«é™¤å»ï¼ˆ[ãƒ¡ãƒ¢] ç­‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ–ãƒ©ã‚±ãƒƒãƒˆã¯ä¿è­·ï¼‰
          result.text = memo.replace(FINANCE_TAG_RE, "").trim();
          return result;
        };

        const parseHours = (raw) => {
          if (!raw) return 0;
          let s = String(raw)
            .replace(/[ï¼š:æ™‚]/g, ":")
            .replace(/[~ï½ã€œï¼â€”â€•ãƒ¼-]/g, "~")
            .replace(/[é–“ï½ˆï¼¨hHæ™‚é–“]/g, "")
            .replace(/[ã€ï¼Œ]/g, ".")
            .trim();

          const toMin = (str) => {
            const t = str.trim();
            if (!t) return 0;
            if (t.includes(":")) {
              const parts = t.split(":");
              return (parseInt(parts[0]) || 0) * 60 + (parseInt(parts[1]) || 0);
            }
            return (parseFloat(t) || 0) * 60;
          };

          // è¤‡æ•°ã®æ™‚é–“å¸¯ã‚’å‡¦ç†
          const timeRanges = s.split(/[\s,ã€]+/).filter(Boolean);
          let totalMinutes = 0;

          for (const range of timeRanges) {
            if (range.includes("~")) {
              const parts = range.split("~");
              if (parts.length === 2 && parts[0] && parts[1]) {
                const start = toMin(parts[0]);
                let end = toMin(parts[1]);
                // çµ‚äº†æ™‚åˆ»ãŒé–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå‰ã®å ´åˆã¯ç¿Œæ—¥ã¨åˆ¤æ–­
                if (end < start) end += 24 * 60;
                totalMinutes += end - start;
              }
            } else {
              // å˜ä¸€ã®æ•°å€¤ï¼ˆæ™‚é–“ï¼‰ã®å ´åˆ
              totalMinutes += (parseFloat(range) || 0) * 60;
            }
          }

          // 15åˆ†å˜ä½ã«ä¸¸ã‚ã‚‹
          const totalHours = totalMinutes / 60;
          return Math.round(totalHours * 4) / 4;
        };
        window.parseHours = parseHours;

        const safeParseFinance = (val) => {
          if (val === undefined || val === null || val === "") return 0;
          if (typeof val === "number") return val;
          let s = String(val)
            .replace(/[æšå††å€‹ç‰]/g, "")
            .replace(/[ï¼Œ,]/g, "")
            .replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, (m) =>
              String.fromCharCode(m.charCodeAt(0) - 0xfee0)
            )
            .trim();
          return parseFloat(s) || 0;
        };

        const handleAnalyze = (report, mode, isInitial) => {
          if (!report || !window.HOKUTO_MASTER) return;
          try {
            const master = window.HOKUTO_MASTER[mode] || {};
            // å†…å®¹ã®Source of Truth: ç·¨é›†å¾Œ(details)ã‚’å„ªå…ˆã—ã€ãªã‘ã‚Œã°åˆæœŸãƒ‡ãƒ¼ã‚¿(ç¨¼å‹•å†…å®¹)ã‚’ä½¿ç”¨
            const content = String(
              getField(report, ["details", "ç¨¼å‹•å†…å®¹", "ç¨¼åƒå†…å®¹", "å†…å®¹"])
            );
            const lines = content.split("\n");
            let results = lines
              .map((line) => {
                if (!line.trim()) return null;
                let match = {
                  text: line.trim(),
                  ev: 0,
                  machine: "",
                  color: "bg-slate-400",
                  source: "",
                };
                // ã€Œæœ€é•·ä¸€è‡´ã€ã«ã‚ˆã‚‹æ©Ÿç¨®ç‰¹å®šãƒ­ã‚¸ãƒƒã‚¯
                let bestMatch = null;
                let longestKeywordLen = 0;

                dictionary.forEach((d) => {
                  const keywords = (d.ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ || "")
                    .split(/[,ï¼Œã€]/)
                    .map((k) => k.trim().toLowerCase())
                    .filter(Boolean);

                  keywords.forEach((k) => {
                    // éƒ¨åˆ†ä¸€è‡´ã§ã¯ãªãæœ€é•·ä¸€è‡´ã‚’æ¡ç”¨ã™ã‚‹ã“ã¨ã§ã€Œãƒˆãƒ©ãƒ–ãƒ«ã€ã¨ã€Œãƒ©ãƒ–ã€ã®è¡çªã‚’å›é¿
                    if (line.toLowerCase().includes(k)) {
                      if (k.length > longestKeywordLen) {
                        longestKeywordLen = k.length;
                        bestMatch = d;
                      }
                    }
                  });
                });
                const foundDict = bestMatch;
                if (foundDict) {
                  match.machine = foundDict.æ©Ÿç¨®å;
                  match.color = foundDict.è‰²ã‚³ãƒ¼ãƒ‰;

                  // ç¬¦å·ã®æ­£è¦åŒ–ï¼ˆå…¨è§’ã‚„ç‰¹æ®Šè¨˜å·ã‚’åŠè§’ã«çµ±ä¸€ï¼‰
                  const normLine = line
                    .replace(/[ï¼‹]/g, "+")
                    .replace(/[ï¼ãƒ¼â€•ãƒ¼âˆ’âˆ’â€-]/g, "-");

                  const gMatch = normLine.match(/(\d+)\s*[Gg]/);
                  const sMatch = normLine.match(/([+-]?\d+)\s*[æšæš]/);
                  const signedMatch = normLine.match(/([+-]\d+)/);
                  const allNums = (normLine.match(/-?\d+/g) || []).map(Number);
                  const isReset = /ãƒªã‚»|ãƒªã‚»ãƒƒãƒˆ|è¨­å®šå¤‰æ›´|å¤‰æ›´å¾Œ/.test(
                    normLine
                  );

                  let gCount = 0;
                  let diff = NaN;

                  if (gMatch) gCount = parseInt(gMatch[1]);
                  if (sMatch) {
                    diff = parseInt(sMatch[1]);
                  } else if (signedMatch) {
                    diff = parseInt(signedMatch[1]);
                  }

                  if (isNaN(diff)) {
                    if (gCount !== 0) {
                      diff = allNums.find((n) => n !== gCount) ?? 0;
                    } else {
                      diff = allNums[1] ?? 0;
                    }
                  }
                  if (gCount === 0) {
                    gCount =
                      allNums.find((n) => n !== diff) ??
                      (allNums.length > 0 ? allNums[0] : 0);
                  }
                  if (isNaN(diff)) diff = 0;

                  if (match.machine === "ã‚¹ãƒã‚¹ãƒ­åŒ—æ–—ã®æ‹³") {
                    const sheets = Object.keys(master);
                    let selected = "";
                    if (isReset) {
                      selected = sheets.find(
                        (s) => s.includes("å¤‰æ›´") || s.includes("ãƒªã‚»")
                      );
                    } else {
                      const getRangeName = (d) => {
                        if (d < -1400) return "-1400æšæœªæº€";
                        if (d <= -1001) return "-1400ï½-1001æš";
                        if (d <= -601) return "-1000ï½-601æš";
                        if (d <= -401) return "-600ï½-401æš";
                        if (d <= -301) return "-400ï½-301æš";
                        if (d <= -201) return "-300ï½-201æš";
                        if (d <= -101) return "-200ï½-101æš";
                        if (d <= -1) return "-100ï½-1æš";
                        if (d <= 99) return "Â±0ï½+99æš";
                        if (d <= 199) return "+100ï½+199æš";
                        if (d <= 299) return "+200ï½+299æš";
                        if (d <= 399) return "+300ï½+399æš";
                        if (d <= 599) return "+400ï½+599æš";
                        if (d <= 799) return "+600ï½+799æš";
                        if (d <= 999) return "+800ï½+999æš";
                        if (d <= 1199) return "+1000ï½+1199æš";
                        if (d <= 1399) return "+1200ï½+1399æš";
                        if (d <= 1999) return "+1400ï½+1999æš";
                        return "+2000æšä»¥ä¸Š";
                      };
                      const targetName = getRangeName(diff);
                      const normalize = (k) =>
                        k
                          .replace(/[Â±æšï¼ˆï¼‰()\[\]\sã€€]/g, "")
                          .replace(/[ã€œã€œ~]/g, "ï½")
                          .trim();
                      const normTarget = normalize(targetName);
                      selected = sheets.find(
                        (sh) => normalize(sh) === normTarget
                      );
                      if (!selected && diff >= 0 && diff <= 99) {
                        selected = sheets.find(
                          (sh) => sh.includes("é€šå¸¸") || sh.includes("åŸºæœ¬")
                        );
                      }
                    }
                    if (selected) {
                      match.source = selected;
                      match.ev = matchEvInRange(gCount, master[selected]);
                    }
                  }
                }
                if (
                  isInitial &&
                  match.machine &&
                  match.machine !== "ã‚¹ãƒã‚¹ãƒ­åŒ—æ–—ã®æ‹³" &&
                  match.machine !== "ãã®ä»–"
                ) {
                  const history = (archive || []).filter(
                    (h) =>
                      h &&
                      (String(h.details || "").includes(match.machine) ||
                        h.machine === match.machine)
                  );
                  if (history.length > 0) {
                    const best =
                      history.find(
                        (h) =>
                          h &&
                          (h.details === line ||
                            String(h.details || "").includes(line))
                      ) || history[0];
                    if (best && best.ev) {
                      match.prediction = {
                        ev: best.ev,
                        date: best.date,
                        name: best.name,
                      };
                    }
                  }
                }
                return match;
              })
              .filter(Boolean);

            // ã€Task 3å¯¾å¿œã€‘æœŸå¾…å€¤ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã€è§£æçµæœãŒç©ºã§ã‚‚å…¥åŠ›æ¬„ã‚’è¡¨ç¤º
            const existingEv =
              parseFloat(getField(report, ["æœŸå¾…å€¤", "ev", "EV"])) || 0;
            if (results.length === 0 && existingEv !== 0) {
              results.push({
                text: "å–å¾—æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿",
                ev: existingEv,
                machine: "ãã®ä»–",
                color: "bg-slate-400",
                source: "",
              });
            }
            setLogs(results);

            // ã€Task 1 & 2å¯¾å¿œã€‘
            // åˆå›èª­ã¿è¾¼ã¿æ™‚(isInitial=true)ã®ã¿editDataã‚’æ§‹ç¯‰ã€‚
            // å†è§£ææ™‚ã¯ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚„å‚™è€ƒæ¬„ã‚’ä¸Šæ›¸ãã›ãšä¿æŒã™ã‚‹ã€‚
            const currentCommon = isInitial && editData ? {
              rawHours: editData.rawHours,
              salary: editData.salary,
              handover: editData.handover
            } : null;

            if (isInitial) {
              const finance = parseFinance(report);
              const initialData = {
                ...report,
                ID: getField(report, ["ID", "id", "å—ä»˜ç•ªå·"]),
                å ±å‘Šè€…: getField(report, ["å ±å‘Šè€…", "name", "åå‰", "Worker"]),
                åº—èˆ—å: getField(report, ["åº—èˆ—å", "store", "åº—å"]),
                æ—¥ä»˜: getField(report, ["æ—¥ä»˜", "date", "ç¨¼åƒæ—¥"]),
                rawHours: currentCommon ? currentCommon.rawHours : getField(report, [
                  "rawHours",
                  "hours_str",
                  "æ™‚é–“å…¥åŠ›å€¤",
                  "ç¨¼åƒæ™‚é–“",
                  "0",
                ]),
                exchange: getField(report, ["æ›é‡‘é¡", "exchange", "ç¾é‡‘åŒ–", "æ›é‡‘"]) || 0,
                handover: currentCommon ? currentCommon.handover : getField(report, ["æ‰‹æ¸¡ã—é¡", "æ‰‹æ¸¡ã—", "handover", 0]),
                parentReceived: getField(report, ["è¦ªå—å–é¡", "parentReceived", "è¦ªå—å–"]) || 0,
                medal20: getField(report, ["20ã‚¹ãƒ­", "æœ€çµ‚ãƒ¡ãƒ€ãƒ«æšæ•°", "medal", "æšæ•°", "medal20"]) || finance.medal20,
                medal5: getField(report, ["5ã‚¹ãƒ­", "medal5"]) || finance.medal5,
                pachi4: getField(report, ["4ãƒ‘ãƒ", "pachi4", "4å††"]) || finance.pachi4,
                cash: getField(report, ["æœ¬æ—¥æŠ•è³‡", "cash", "æŠ•è³‡", "æœ¬æ—¥æŠ•è³‡é¡"]) || finance.cash,
                salary: currentCommon ? currentCommon.salary : (getField(report, ["æœ¬æ—¥ã®çµ¦æ–™", "salary", "çµ¦æ–™"]) || finance.salary),
                remaining: getField(report, ["æ®‹æŠ•è³‡é‡‘", "remainingCash", "æ®‹é«˜", "remaining"]) || finance.remaining,
                memo: getField(report, ["å‚™è€ƒ", "memo", "å‚™è€ƒæ¬„"]),
                details: getField(report, ["details", "ç¨¼å‹•å†…å®¹", "ç¨¼åƒå†…å®¹", "å†…å®¹"]),
                imageUrls: getField(report, ["ç”»åƒURL", "imageUrls", "images"]) || "",
                ev: existingEv,
              };
              
              setEditData(initialData);
              if (initialData.ID) setSelectedId(initialData.ID);
              if (initialData.details) fetchAiNormalization(initialData.details);
            }
          } catch (e) {
            console.error("Analysis Error:", e);
            alert("è§£æã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\nç†ç”±: " + e.message);
          }
        };

        const fetchAiNormalization = async (details) => {
          setIsAiAnalyzing(true);
          setAiNormalization(null);
          try {
            const res = await fetch(
              `${GAS_URL}?action=getAISuggestion&details=${encodeURIComponent(
                details
              )}`
            );
            const data = await res.json();
            if (data && !data.error) {
              setAiNormalization(data);
            }
          } catch (e) {
            console.error("AI Normalization Error:", e);
          } finally {
            setIsAiAnalyzing(false);
          }
        };

        const handleSaveEdit = async () => {
          setLoading(true);
          const group = reports.find(r => r.id === selectedId);
          if (!group) return;

          // ç·¨é›†ä¸­ã®ç¾åœ¨ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ç‰¹å®š
          const updatedStore = {
            ...editData,
            åå‰: editData.å ±å‘Šè€…,
            åº—èˆ—å: editData.åº—èˆ—å,
            ç¨¼å‹•å†…å®¹: editData.details,
            rawHours: editData.rawHours || editData.ç¨¼åƒæ™‚é–“,
            medal20: safeParseFinance(editData.medal20),
            medal5: safeParseFinance(editData.medal5),
            pachi4: safeParseFinance(editData.pachi4),
            cash: safeParseFinance(editData.cash),
            salary: safeParseFinance(editData.salary),
            exchange: safeParseFinance(editData.exchange),
            handover: safeParseFinance(editData.handover),
            parentReceived: safeParseFinance(editData.parentReceived),
            remaining: safeParseFinance(editData.remaining),
            å‚™è€ƒ: editData.memo,
          };

          try {
            await fetch(GAS_URL, {
              method: "POST",
              mode: "no-cors",
              body: JSON.stringify({
                action: "updatePendingReport",
                data: {
                  ...updatedStore,
                  id: updatedStore.ID,
                  date: updatedStore.æ—¥ä»˜,
                  name: updatedStore.å ±å‘Šè€…,
                  store: updatedStore.åº—èˆ—å,
                  hours: updatedStore.rawHours,
                },
              }),
            });

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆã‚’æ›´æ–°ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—å†…ã®è©²å½“åº—èˆ—ã®ã¿å·®ã—æ›¿ãˆï¼‰
            setReports(
              reports.map((r) =>
                r.id === selectedId
                  ? {
                      ...r,
                      stores: r.stores.map(s => String(s.ID) === String(editData.ID) ? { ...s, ...updatedStore } : s)
                    }
                  : r
              )
            );
            alert("åº—èˆ—æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
          } catch (e) {
            alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + e.message);
          } finally {
            setLoading(false);
          }
        };

        const onApprove = async () => {
          const group = reports.find((r) => r.id === selectedId);
          if (!group) return;

          setLoading(true);
          setSyncInfo("ğŸš¢ ã‚°ãƒ«ãƒ¼ãƒ—ä¸€æ‹¬æ‰¿èªä¸­...");

          try {
            // ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®å…¨åº—èˆ—ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦æ‰¿èªAPIã‚’å©ã
            // æœ¬æ¥ã¯ä¸€æ‹¬æ‰¿èªAPIã‚’ç”¨æ„ã™ã‚‹ã®ãŒç†æƒ³ã ãŒã€æ—¢å­˜ã®approveReportã‚’é †æ¬¡å®Ÿè¡Œã™ã‚‹
            for (const store of group.stores) {
              const isCurrent = String(store.ID) === String(editData.ID);
              const targetData = isCurrent ? editData : store;
              const targetLogs = isCurrent ? logs : (targetData.metadata ? JSON.parse(targetData.metadata) : []);

              const payload = {
                id: targetData.ID,
                date: editData.æ—¥ä»˜, // ã‚°ãƒ«ãƒ¼ãƒ—å…±é€š
                name: group.name,
                store: targetData.åº—èˆ—å,
                ev: isCurrent ? logs.reduce((s, l) => s + l.ev, 0) : (parseFloat(targetData.æœŸå¾…å€¤) || 0),
                hours: parseHours(editData.rawHours), // ã‚°ãƒ«ãƒ¼ãƒ—å…±é€šé …ç›®ã¨ã—ã¦åŒæœŸ
                exchange: safeParseFinance(targetData.exchange || targetData.æ›é‡‘é¡),
                handover: safeParseFinance(editData.handover), // ã‚°ãƒ«ãƒ¼ãƒ—å…±é€šé …ç›®ã¨ã—ã¦åŒæœŸ
                parentReceived: safeParseFinance(targetData.parentReceived || targetData.è¦ªå—å–é¡),
                medal20: safeParseFinance(targetData.medal20 || targetData["20ã‚¹ãƒ­"]),
                medal5: safeParseFinance(targetData.medal5 || targetData["5ã‚¹ãƒ­"]),
                pachi4: safeParseFinance(targetData.pachi4 || targetData["4ãƒ‘ãƒ"]),
                salary: safeParseFinance(editData.salary), // ã‚°ãƒ«ãƒ¼ãƒ—å…±é€šé …ç›®ã¨ã—ã¦åŒæœŸ
                memo: targetData.memo || targetData.å‚™è€ƒ,
                details: targetData.details || targetData.ç¨¼å‹•å†…å®¹,
                imageUrls: targetData.imageUrls || targetData.ç”»åƒURL || "",
                metadata: JSON.stringify(
                  targetLogs.map((l) => ({ line: l.text || l.line, machine: l.machine, ev: l.ev }))
                ),
                reportId: group.id
              };

              await fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify({ action: "approveReport", data: payload }),
              });
            }

            setReports(reports.filter((r) => r.id !== selectedId));
            setSelectedId(null);
            setLogs([]);
            setCheckedIds(checkedIds.filter((id) => id !== selectedId));
            setSyncInfo("âœ… ã‚°ãƒ«ãƒ¼ãƒ—æ‰¿èªå®Œäº†");
          } catch (e) {
            setSyncInfo("âŒ æ‰¿èªã‚¨ãƒ©ãƒ¼");
            alert("æ‰¿èªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
          } finally {
            setLoading(false);
          }
        };

        const onDeleteSelected = async () => {
          if (checkedIds.length === 0) return;
          if (!confirm(`${checkedIds.length}ã‚°ãƒ«ãƒ¼ãƒ—ã®å…¨å ±å‘Šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
          setLoading(true);
          
          try {
            // å„ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®å…¨ã¦ã®è¡ŒIDã‚’å–å¾—
            const allRowIds = checkedIds.flatMap(groupId => {
              const group = reports.find(r => r.id === groupId);
              return group ? group.stores.map(s => s.ID) : [];
            });

            await fetch(GAS_URL, {
              method: "POST",
              mode: "no-cors",
              body: JSON.stringify({
                action: "deleteReports",
                data: { ids: allRowIds },
              }),
            });
            setReports(reports.filter((r) => !checkedIds.includes(r.id)));
            if (checkedIds.includes(selectedId)) {
              setSelectedId(null);
              setLogs([]);
            }
            setCheckedIds([]);
          } catch (e) {
            alert(e.message);
          } finally {
            setLoading(false);
          }
        };

        if (isLocked)
          return (
            <div className="flex items-center justify-center min-h-screen bg-slate-950 p-6 text-center text-white">
              <div className="w-full max-w-sm space-y-8 animate-fadeIn">
                <h1 className="text-4xl font-black italic text-[#0076FF] tracking-tighter uppercase">
                  Admin Console
                </h1>
                <form
                  onSubmit={(e) => {
                    e.preventDefault();
                    if (passInput === APP_PASS) {
                      setIsLocked(false);
                      localStorage.setItem("ap_v7", APP_PASS);
                      loadAll();
                    } else {
                      alert("Failed");
                    }
                  }}
                  className="bg-slate-900 p-8 rounded-[2.5rem] border border-white/5 space-y-6"
                >
                  <input
                    type="password"
                    value={passInput}
                    onChange={(e) => setPassInput(e.target.value)}
                    className="w-full bg-slate-800 border-none rounded-2xl py-4 text-center text-white font-black outline-none focus:ring-2 ring-[#0076FF]"
                    placeholder="åˆè¨€è‘‰"
                    autoFocus
                  />
                  <button
                    type="submit"
                    className="w-full bg-[#0076FF] py-4 rounded-2xl text-white font-black shadow-lg"
                  >
                    AUTHENTICATE
                  </button>
                </form>
              </div>
            </div>
          );

        return (
          <div className="flex h-[100dvh] overflow-hidden bg-slate-50">
            {showMaster && (
              <MasterConsole
                dictionary={dictionary}
                strategyData={strategyData}
                resetMaster={resetMaster}
                onSave={(data) => {
                  setDictionary(data.dictionary);
                  setStrategyData(data.strategy);
                  setResetMaster(data.reset);
                  loadAll(); // æ°¸ç¶šåŒ–å¾Œã®å†åŒæœŸ
                }}
                onClose={() => setShowMaster(false)}
              />
            )}
            {showAnalytics && (
              <AnalyticsModal onClose={() => setShowAnalytics(false)} />
            )}
            {showSecurity && (
              <SecurityHub onClose={() => setShowSecurity(false)} />
            )}
            {showLibrary && (
              <ArchiveLibrary
                archive={archive}
                onClose={() => setShowLibrary(false)}
              />
            )}
            <div className="mobile-header bg-slate-900 px-6 flex items-center justify-between lg:hidden text-white font-black italic">
              <span>ç®¡ç†è€…ã‚¢ãƒ—ãƒª</span>
              <button
                onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                className="text-2xl p-2 active:scale-90 transition-all"
              >
                â˜°
              </button>
            </div>
            <div
              className={`sidebar flex flex-col ${isSidebarOpen ? "open" : ""}`}
            >
              <div className="p-8 border-b border-white/5 flex justify-between items-center bg-slate-900 sticky top-0 z-10">
                <div>
                  <h1 className="text-2xl font-black text-white italic text-glow">
                    æ‰¿èªå¾…ã¡ãƒªã‚¹ãƒˆ
                  </h1>
                  <p className="text-[10px] text-slate-500 font-bold mt-2 uppercase tracking-widest opacity-50 font-mono">
                    {syncInfo}
                  </p>
                </div>
                {checkedIds.length > 0 && (
                  <button
                    onClick={onDeleteSelected}
                    className="text-rose-500 animate-pulse text-xl"
                  >
                    ğŸ—‘
                  </button>
                )}
              </div>
              <div className="p-4 border-b border-white/5">
                <button
                  onClick={() => location.reload(true)}
                  className="w-full bg-indigo-500/10 border border-indigo-500/20 py-4 rounded-xl text-indigo-400 text-[10px] font-black tracking-widest hover:bg-indigo-500/20 active:scale-95 transition-all"
                >
                  æœ€æ–°Ver.ã«æ›´æ–° ğŸ”„
                </button>
              </div>
              <div className="flex-1 scroll-container custom-scroll p-4 space-y-2">
                {reports.map((r) => (
                  <div
                    key={r.id}
                    onClick={() => {
                      setSelectedId(r.id);
                      setIsSidebarOpen(false);
                      // æœ€åˆã®åº—èˆ—ã®ãƒ‡ãƒ¼ã‚¿ã§åˆæœŸè§£æã‚’è¡Œã†
                      handleAnalyze(r.stores[0], evMode, true);
                    }}
                    className={`p-5 rounded-[1.5rem] cursor-pointer transition-all ${
                      selectedId === r.id
                        ? "bg-[#0076FF] text-white shadow-xl translate-x-1"
                        : "hover:bg-white/5 text-slate-400"
                    }`}
                  >
                    <div className="flex items-center gap-4">
                      <div
                        onClick={(e) => {
                          e.stopPropagation();
                          setCheckedIds((prev) =>
                            prev.includes(r.id)
                              ? prev.filter((x) => x !== r.id)
                              : [...prev, r.id]
                          );
                        }}
                        className={`w-6 h-6 rounded-lg flex items-center justify-center border-2 transition-all ${
                          checkedIds.includes(r.id)
                            ? "bg-white border-white"
                            : "border-white/10"
                        }`}
                      >
                        {checkedIds.includes(r.id) && (
                          <span className="text-[#0076FF] font-black text-xs">
                            âœ“
                          </span>
                        )}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="flex justify-between items-baseline mb-1">
                          <div className="text-sm font-black text-white truncate">
                            {r.name}
                          </div>
                          <div className="text-[8px] font-black opacity-40 uppercase font-mono ml-2 shrink-0">
                            {formatDateLocal(r.date)}
                          </div>
                        </div>
                        <div className="font-bold text-[10px] truncate opacity-80 text-slate-400">
                          {r.stores.length > 1 ? `${r.stores[0].åº—èˆ—å} å¤–${r.stores.length-1}åº—èˆ—` : r.stores[0].åº—èˆ—å}
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
              <div className="p-6 border-t border-white/5 space-y-3">
                <button
                  onClick={() => !loading && setShowMaster(true)}
                  disabled={loading}
                  className={`w-full py-4 rounded-xl text-[10px] font-black tracking-widest transition-all ${
                    loading
                      ? "bg-slate-800 text-slate-600 cursor-not-allowed"
                      : "bg-blue-600/10 border border-blue-600/20 text-blue-400 hover:bg-blue-600/20"
                  }`}
                >
                  {loading ? "âŒ› SYNCING DATA..." : "ğŸ“– MASTER CONSOLE"}
                </button>
                <button
                  onClick={() => setShowSecurity(true)}
                  className="w-full bg-indigo-600 py-4 rounded-xl text-white text-[10px] font-black tracking-widest"
                >
                  ğŸ›¡ï¸ SECURITY HUB
                </button>
                <button
                  onClick={() => setShowAnalytics(true)}
                  className="w-full bg-emerald-600 py-4 rounded-xl text-white text-[10px] font-black tracking-widest"
                >
                  ğŸ“Š ANALYTICS
                </button>
                <button
                  onClick={() => setShowLibrary(true)}
                  className="w-full bg-indigo-500/20 border border-indigo-500/30 py-4 rounded-xl text-indigo-400 text-[10px] font-black tracking-widest hover:bg-indigo-500/30 transition-all"
                >
                  ğŸ“š ARCHIVE LIBRARY
                </button>
              </div>
            </div>
            {/* ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒãƒƒã‚¯ãƒ‰ãƒ­ãƒƒãƒ— */}
            {isSidebarOpen && (
              <div
                className="sidebar-backdrop"
                onClick={() => setIsSidebarOpen(false)}
              />
            )}
            <div className="main scroll-container">
              {(() => {
                const group = reports.find((r) => r.id === selectedId);
                if (!group || !editData) return (
                  <div className="h-full flex flex-col items-center justify-center text-slate-200 text-6xl font-black italic opacity-60 text-center p-10">
                    <div className="tracking-tighter">ç®¡ç†è€…ã‚¢ãƒ—ãƒª</div>
                    <div className="text-[11px] tracking-[1.5em] mt-8 opacity-70 font-black">
                      Select Report to Start
                    </div>
                  </div>
                );
                return (
                  <div className="max-w-4xl mx-auto space-y-6 animate-fadeIn pb-20">
                    {/* A-1: åŸºæœ¬æƒ…å ± & å…±é€šé …ç›® (æœ€ä¸Šéƒ¨ã¸ç§»å‹•) */}
                    <div className="bg-slate-900 rounded-[2.5rem] p-10 lg:p-14 text-white shadow-xl relative overflow-hidden border border-white/10">
                      <span className="absolute top-4 left-8 text-[10px] font-black text-slate-500 uppercase tracking-widest z-20">
                        åŸºæœ¬æƒ…å ±
                      </span>
                      <div className="flex flex-col gap-8">
                        {/* å ±å‘Šè€…ãƒ»æ—¥ä»˜ */}
                        <div className="grid grid-cols-2 gap-10 uppercase text-[9px] font-black text-slate-500">
                          <div>
                            <div className="mb-1 opacity-50">å ±å‘Šè€… / Operator</div>
                            <div className="text-base font-black text-white italic tracking-tighter">{editData.å ±å‘Šè€…}</div>
                          </div>
                          <div>
                            <div className="mb-2 opacity-50">ç¨¼åƒæ—¥ / Work Date</div>
                            <input
                              type="date"
                              value={formatDateLocal(editData.æ—¥ä»˜)}
                              onChange={(e) => setEditData({ ...editData, æ—¥ä»˜: e.target.value })}
                              className="bg-white/10 border border-white/20 text-sm font-black text-white italic px-3 py-1.5 rounded-xl outline-none focus:border-indigo-500/50"
                            />
                          </div>
                        </div>

                        {/* å…±é€šé …ç›®: æ™‚é–“ãƒ»çµ¦æ–™ãƒ»æ‰‹æ¸¡ã— */}
                        <div className="grid grid-cols-3 gap-4 border-t border-white/5 pt-8">
                          <div>
                            <div className="text-[10px] font-black text-slate-500 uppercase mb-2">ç¨¼åƒæ™‚é–“</div>
                            <input
                              value={editData.rawHours || ""}
                              onChange={(e) => setEditData({ ...editData, rawHours: e.target.value })}
                              className="w-full bg-white/10 border border-white/10 p-3 rounded-xl text-xs font-black text-white"
                              placeholder="8:40~21:10"
                            />
                          </div>
                          <div>
                            <div className="text-[10px] font-black text-emerald-500 uppercase mb-2">æœ¬æ—¥ã®çµ¦æ–™</div>
                            <input
                              value={editData.salary ?? 0}
                              onChange={(e) => setEditData({ ...editData, salary: e.target.value })}
                              className="w-full bg-white/10 border border-white/10 p-3 rounded-xl text-xs font-black text-white"
                            />
                          </div>
                          <div>
                            <div className="text-[10px] font-black text-amber-500 uppercase mb-2">è¦ªã¸æ‰‹æ¸¡ã—</div>
                            <input
                              value={editData.handover ?? 0}
                              onChange={(e) => setEditData({ ...editData, handover: e.target.value })}
                              className="w-full bg-white/10 border border-white/10 p-3 rounded-xl text-xs font-black text-white"
                            />
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* åº—èˆ—åˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ–ï¼ˆè¤‡æ•°åº—èˆ—ã®å ´åˆï¼‰ */}
                    {group.stores.length > 1 && (
                      <div className="flex gap-2 bg-slate-200 p-1 rounded-2xl overflow-x-auto shadow-inner">
                        {group.stores.map((s, idx) => (
                          <button
                            key={idx}
                            onClick={() => handleAnalyze(s, evMode, true)}
                            className={`px-6 py-3 rounded-xl text-[10px] font-black whitespace-nowrap transition-all ${
                              editData.åº—èˆ—å === s.åº—èˆ—å
                                ? "bg-white shadow text-[#0076FF]"
                                : "text-slate-500 hover:text-slate-700"
                            }`}
                          >
                            {s.åº—èˆ—å || `åº—èˆ—${idx+1}`}
                          </button>
                        ))}
                      </div>
                    )}

                    {/* A-2: å ±å‘Šè©³ç´° (1æ—¥ã®ã¾ã¨ã‚) */}
                    <div className="bg-slate-900 rounded-[2.5rem] p-10 lg:p-14 text-white shadow-xl relative overflow-hidden border border-white/10">
                      <span className="absolute top-4 left-8 text-[10px] font-black text-slate-500 uppercase tracking-widest z-20">
                        å ±å‘Šè©³ç´°
                      </span>
                      <div className="flex flex-col gap-8">
                        {/* Gemini AI UI (çœç•¥ä¸­) */}
                        {(isAiAnalyzing || aiNormalization) && (
                          <div className="bg-white/5 border border-white/10 p-8 rounded-[2.5rem] space-y-6 animate-fadeIn relative overflow-hidden">
                            <div className="flex items-center justify-between mb-2">
                              <div className="flex items-center gap-3">
                                <span className={`text-xl ${isAiAnalyzing ? "animate-spin" : ""}`}>{isAiAnalyzing ? "âœ¨" : "ğŸ¤–"}</span>
                                <div>
                                  <h4 className="text-[10px] font-black italic text-slate-900 leading-none">AIå…¥åŠ›è£œåŠ©</h4>
                                </div>
                              </div>
                            </div>
                            {aiNormalization && !isAiAnalyzing && (
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-8 animate-fadeIn">
                                <div className="space-y-4">
                                  <div className="space-y-2">
                                    <div className="text-[9px] font-black text-slate-500 uppercase ml-1 tracking-widest">Normalizing: Machine</div>
                                    <div className="bg-white/10 px-4 py-3 rounded-2xl text-xs font-black border border-white/5 text-white italic">{aiNormalization.machine}</div>
                                  </div>
                                  <div className="space-y-2">
                                    <div className="text-[9px] font-black text-slate-500 uppercase ml-1 tracking-widest">Normalizing: Store</div>
                                    <div className="flex items-center gap-3">
                                      <div className="bg-white/10 px-4 py-3 rounded-2xl text-xs font-black border border-white/5 text-white italic truncate">{aiNormalization.store}</div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            )}
                          </div>
                        )}

                        <div className="bg-slate-900/50 p-6 rounded-3xl border border-white/10">
                          <div className="flex justify-between items-center mb-3 px-1">
                            <div className="text-[10px] font-black text-slate-500 uppercase tracking-widest">ç¨¼åƒãƒ­ã‚°è©³ç´°</div>
                            <div className="flex gap-2">
                              <button onClick={() => handleAnalyze(editData, evMode, false)} className="text-[9px] font-black bg-indigo-500/20 text-indigo-400 px-3 py-1.5 rounded-lg">å†è§£æ</button>
                              <button onClick={handleSaveEdit} className="text-[9px] font-black bg-emerald-500/20 text-emerald-400 px-3 py-1.5 rounded-lg">åº—èˆ—ä¿å­˜</button>
                            </div>
                          </div>
                          <textarea
                            value={editData.details}
                            onChange={(e) => setEditData({ ...editData, details: e.target.value })}
                            className="w-full bg-slate-800/50 border border-white/10 p-4 rounded-2xl text-xs font-bold min-h-[150px] outline-none text-white"
                          />
                        </div>
                      </div>
                    </div>

                    {/* B: ç¨¼åƒæ•°ä¾¡ */}
                    <div className="bg-white rounded-[3.5rem] p-6 lg:p-8 shadow-2xl border border-slate-100 space-y-10">
                      <div className="border border-slate-100 rounded-[2.5rem] p-8 lg:p-10 relative">
                        <span className="absolute -top-3 left-8 bg-white px-2 text-[10px] font-black text-slate-400 uppercase tracking-widest">åº—èˆ—åˆ¥ãƒªã‚¶ãƒ«ãƒˆ</span>
                        <div className="space-y-8">
                          <div className="bg-slate-50 p-6 rounded-3xl border border-slate-100">
                            <div className="text-[10px] font-black text-slate-400 uppercase mb-2 ml-1">åº—èˆ—å</div>
                            <input value={editData.åº—èˆ—å || ""} onChange={(e) => setEditData({ ...editData, åº—èˆ—å: e.target.value })} className="bg-white border text-lg font-black px-4 py-3 rounded-xl w-full" />
                          </div>

                          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                              <label className="text-[9px] font-black text-rose-500 uppercase ml-1">20ã‚¹ãƒ­</label>
                              <input value={editData.medal20 ?? 0} onChange={(e) => setEditData({ ...editData, medal20: e.target.value })} className="bg-white border text-base font-black px-4 py-2 rounded-xl w-full" />
                            </div>
                            <div>
                              <label className="text-[9px] font-black text-indigo-500 uppercase ml-1">5ã‚¹ãƒ­</label>
                              <input value={editData.medal5 ?? 0} onChange={(e) => setEditData({ ...editData, medal5: e.target.value })} className="bg-white border text-base font-black px-4 py-2 rounded-xl w-full" />
                            </div>
                            <div>
                              <label className="text-[9px] font-black text-emerald-500 uppercase ml-1">4ãƒ‘ãƒ</label>
                              <input value={editData.pachi4 ?? 0} onChange={(e) => setEditData({ ...editData, pachi4: e.target.value })} className="bg-white border text-base font-black px-4 py-2 rounded-xl w-full" />
                            </div>
                          </div>

                          <div className="grid grid-cols-2 gap-4">
                            <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                              <div className="text-[9px] font-black text-rose-500 uppercase mb-1">æœ¬æ—¥æŠ•è³‡</div>
                              <input value={editData.cash ?? 0} onChange={(e) => setEditData({ ...editData, cash: e.target.value })} className="w-full bg-white border text-sm font-black px-3 py-2 rounded-xl" />
                            </div>
                            <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                              <div className="text-[9px] font-black text-indigo-500 uppercase mb-1">è¦ªã‹ã‚‰å—å–</div>
                              <input value={editData.parentReceived ?? 0} onChange={(e) => setEditData({ ...editData, parentReceived: e.target.value })} className="w-full bg-white border text-sm font-black px-3 py-2 rounded-xl" />
                            </div>
                            <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                              <div className="text-[9px] font-black text-emerald-500 uppercase mb-1">æ›é‡‘é¡</div>
                              <input value={editData.exchange ?? 0} onChange={(e) => setEditData({ ...editData, exchange: e.target.value })} className="w-full bg-white border text-sm font-black px-3 py-2 rounded-xl" />
                            </div>
                            <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                              <div className="text-[9px] font-black text-amber-500 uppercase mb-1">æ®‹æŠ•è³‡é‡‘</div>
                              <input value={editData.remaining ?? 0} onChange={(e) => setEditData({ ...editData, remaining: e.target.value })} className="w-full bg-white border text-sm font-black px-3 py-2 rounded-xl" />
                            </div>
                          </div>

                          <textarea value={editData.memo || ""} onChange={(e) => setEditData({ ...editData, memo: e.target.value })} className="w-full bg-slate-50 border p-4 rounded-2xl text-xs font-medium min-h-[80px]" placeholder="å‚™è€ƒ" />
                        </div>
                      </div>

                      {/* C: ç¨¼åƒè©³ç´° (EV) */}
                      <div className="border border-slate-100 rounded-[2.5rem] p-8 lg:p-10 relative">
                        <span className="absolute -top-3 left-8 bg-white px-2 text-[10px] font-black text-slate-400 uppercase tracking-widest">æœŸå¾…å€¤è©³ç´°</span>
                        <div className="space-y-4">
                          {logs.map((log, i) => (
                            <div key={i} className="bg-slate-50 p-4 rounded-2xl border border-slate-100 flex justify-between items-center">
                              <div className="text-xs font-black">{log.machine} : {log.ev}å††</div>
                              <button onClick={() => setLogs(logs.filter((_, idx) => idx !== i))} className="text-rose-400 text-lg">âœ•</button>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>

                    {/* Aggregate Footer */}
                    <div className="bg-[#0076FF] p-10 rounded-[4rem] text-white flex justify-between items-center shadow-2xl">
                      <div>
                        <div className="text-[10px] font-black opacity-50 uppercase">Aggregate EV</div>
                        <div className="text-4xl font-black italic">{logs.reduce((s, l) => s + l.ev, 0).toLocaleString()} å††</div>
                      </div>
                      <button onClick={onApprove} className="bg-white text-[#0076FF] px-10 py-4 rounded-3xl font-black">Approve & Complete</button>
                    </div>
                  </div>
                );
              })()}
            </div>
          </div>
        );
      }
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<AdminApp />);
    </script>
  </body>
</html>
